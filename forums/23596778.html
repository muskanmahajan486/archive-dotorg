<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : "Event" issue in rules.</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : "Event" issue in rules.
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Feb 25, 2015 by <font color="#0050B2">gman0105</font>.
				    </div>

				    <p>Hello,</p>

<p>I have an issue with rules. I have just maid the following test :</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;

rule <span class="code-quote">"mail jour"</span>
   Event( source == <span class="code-quote">"DateTime isDay Sensor"</span>, value == <span class="code-quote">"<span class="code-keyword">true</span>"</span> )
then
   execute.command ( <span class="code-quote">"Send Mail jour"</span> );
end
</pre>
</div></div>

<p>"DateTime isDay Sensor" sensor created by following your "OpenRemote 2.0 How To - DateTime Protocol"</p>

<p>I found errors in boot.log :</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
--------------------------------------------------------------------

  DEPLOYING NEW CONTROLLER RUNTIME...

--------------------------------------------------------------------

ERROR 2015-02-25 20:37:04,350 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2015-02-25 20:37:04,350 : [ERR 101] Line 7:3 no viable alternative at input 'Event' in rule <span class="code-quote">"mail jour"</span>
ERROR 2015-02-25 20:37:04,351 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
	at org.openremote.controller.service.Deployer.startup(Deployer.java:872)
	at org.openremote.controller.service.Deployer.softRestart(Deployer.java:454)
	at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1411)
	at java.lang.<span class="code-object">Thread</span>.run(<span class="code-object">Thread</span>.java:662)
INFO 2015-02-25 20:37:04,357 : Initialized event processor : Drools Rule Engine
INFO 2015-02-25 20:37:04,375 : Initialized event processor : RRD4J Data Logger
INFO 2015-02-25 20:37:04,376 : Initialized event processor : EmonCMS Data Logger
INFO 2015-02-25 20:37:04,437 : Registered sensor : Sensor (Name = 'DisplayDate Sensor', ID = '106628481', State Mappings: {})
INFO 2015-02-25 20:37:04,437 : Registered sensor : Sensor (Name = 'DateTime isDay Sensor', ID = '106628482', State Mappings: {})
INFO 2015-02-25 20:37:04,440 : Registered sensor : Switch Sensor (Name = 'ExclusionSwitchSensor', ID = '106629438')
INFO 2015-02-25 20:37:04,442 : Registered sensor : Switch Sensor (Name = 'SMOKE1_ALARM', ID = '106628389')
INFO 2015-02-25 20:37:04,443 : Registered sensor : Level Sensor (Name = 'Position_volet', ID = '106902970', Min: 0, Max: 100)
INFO 2015-02-25 20:37:04,447 : Registered sensor : Switch Sensor (Name = 'inclusionSwitchSensor', ID = '106177579')
INFO 2015-02-25 20:37:04,449 : Registered sensor : Level Sensor (Name = 'SMOKE1_BATTERY_REPORT', ID = '106239579', Min: 0, Max: 100)
INFO 2015-02-25 20:37:04,454 : Startup complete.
INFO 2015-02-25 20:49:15,828 : 

--------------------------------------------------------------------

  DEPLOYING NEW CONTROLLER RUNTIME...

--------------------------------------------------------------------

ERROR 2015-02-25 20:49:18,911 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2015-02-25 20:49:18,911 : [ERR 101] Line 7:3 no viable alternative at input 'Event' in rule <span class="code-quote">"mail jour"</span>
ERROR 2015-02-25 20:49:18,914 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
	at org.openremote.controller.service.Deployer.startup(Deployer.java:872)
	at org.openremote.controller.service.Deployer.startController(Deployer.java:350)
	at org.openremote.controller.spring.SpringContext.initializeController(SpringContext.java:109)
	at org.openremote.controller.service.ServiceContext.init(ServiceContext.java:427)
	at org.openremote.controller.bootstrap.Startup.loadServiceContext(Startup.java:88)
	at org.openremote.controller.bootstrap.servlet.ServletStartup.initializeServiceContext(ServletStartup.java:195)
	at org.openremote.controller.bootstrap.servlet.ServletStartup.contextInitialized(ServletStartup.java:109)
	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:3843)
	at org.apache.catalina.core.StandardContext.start(StandardContext.java:4342)
	at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)
	at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)
	at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)
	at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.java:926)
	at org.apache.catalina.startup.HostConfig.deployDirectories(HostConfig.java:889)
	at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492)
	at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1149)
	at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:311)
	at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)
	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053)
	at org.apache.catalina.core.StandardHost.start(StandardHost.java:719)
	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1045)
	at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:443)
	at org.apache.catalina.core.StandardService.start(StandardService.java:516)
	at org.apache.catalina.core.StandardServer.start(StandardServer.java:710)
	at org.apache.catalina.startup.Catalina.start(Catalina.java:578)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:288)
	at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)
INFO 2015-02-25 20:49:19,298 : Initialized event processor : Drools Rule Engine
INFO 2015-02-25 20:49:19,475 : Initialized event processor : RRD4J Data Logger
INFO 2015-02-25 20:49:19,475 : Initialized event processor : EmonCMS Data Logger
INFO 2015-02-25 20:49:21,621 : Registered sensor : Sensor (Name = 'DisplayDate Sensor', ID = '106628481', State Mappings: {})
INFO 2015-02-25 20:49:21,624 : Registered sensor : Sensor (Name = 'DateTime isDay Sensor', ID = '106628482', State Mappings: {})
INFO 2015-02-25 20:49:21,626 : Registered sensor : Switch Sensor (Name = 'ExclusionSwitchSensor', ID = '106629438')
INFO 2015-02-25 20:49:21,664 : Registered sensor : Switch Sensor (Name = 'SMOKE1_ALARM', ID = '106628389')
INFO 2015-02-25 20:49:21,666 : Registered sensor : Level Sensor (Name = 'Position_volet', ID = '106902970', Min: 0, Max: 100)
INFO 2015-02-25 20:49:21,668 : Registered sensor : Switch Sensor (Name = 'inclusionSwitchSensor', ID = '106177579')
INFO 2015-02-25 20:49:21,670 : Registered sensor : Level Sensor (Name = 'SMOKE1_BATTERY_REPORT', ID = '106239579', Min: 0, Max: 100)
INFO 2015-02-25 20:49:21,677 : Startup complete.
INFO 2015-02-25 20:49:21,678 : Controller Definition File Watcher <span class="code-keyword">for</span> Default Deployer started.
</pre>
</div></div>

<p>I have maid other test with "event", always with same error ?</p>

<p>Could you help me ?</p>

<p>Thanks</p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-23596784"></a>
                                    <font class="smallfont"><p>Hi Guillaume</p>

<p>Try adding this line in your .drl file.</p>

<p>import org.openremote.controller.protocol.Event;</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by kenta at Feb 26, 2015 06:56
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596789"></a>
                                    <font class="smallfont"><p>Hi,</p>

<p>I have tried adding <div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">import</span> org.openremote.controller.protocol.Event;</pre>
</div></div></p>

<p>and also using : <div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">package</span> org.openremote.controller.model.event</pre>
</div></div></p>

<p>I have the same error.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by gman0105 at Feb 26, 2015 12:44
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596790"></a>
                                    <font class="smallfont"><blockquote><p>package org.openremote.controller.model.event<br/>
global org.openremote.controller.statuscache.CommandFacade execute;<br/>
global org.openremote.controller.statuscache.SwitchFacade switches;<br/>
global org.openremote.controller.statuscache.LevelFacade levels;<br/>
import org.openremote.controller.protocol.*;</p></blockquote>

<p>This blurp works for me. Don't ask me why. No one ever bothered to describe it properly in a help file.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Feb 26, 2015 14:33
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596794"></a>
                                    <font class="smallfont"><p>this works for me:<br/>
try to change to CustomState</p>

<p>rule "lamp vaas aan als nacht"<br/>
when<br/>
CustomState(source== "isday sensor", value=="false")<br/>
then<br/>
execute.command("lamp vaas aan");<br/>
end</p>

<p>rule "lamp vaas uit als dag"<br/>
when<br/>
CustomState(source== "isday sensor", value=="true")<br/>
then<br/>
execute.command("lamp vaas uit");<br/>
end</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by robnas at Feb 26, 2015 16:19
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596796"></a>
                                    <font class="smallfont"><p>Thanks everybody,</p>

<p>But that makes me crazy, I have tried PZ1 and ROB advice's. Trying to mixed solution.. <br/>
always the same error.</p>

<p>Perhaps something to check in Java installation/settings ? </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by gman0105 at Feb 26, 2015 18:32
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596797"></a>
                                    <font class="smallfont"><p>add this in your rules for packages. will always work:</p>

<p>//Package, globals and imports:<br/>
package org.openremote.controller.protocol<br/>
global org.openremote.controller.statuscache.CommandFacade execute;<br/>
global org.openremote.controller.statuscache.SwitchFacade switches;<br/>
global org.openremote.controller.statuscache.LevelFacade levels;<br/>
import org.openremote.controller.protocol.*;<br/>
import org.openremote.controller.model.event.*;<br/>
import java.lang.Float;<br/>
import java.sql.Timestamp;<br/>
import java.util.Date; <br/>
import java.util.concurrent.TimeUnit;<br/>
import org.openremote.controller.utils.Logger;<br/>
import org.openremote.controller.Constants;<br/>
import java.io.*;</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by robnas at Feb 26, 2015 18:36
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596803"></a>
                                    <font class="smallfont"><p>I'm sorry, I just forgive to insert "then":</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-comment">//Package, globals and imports:
</span><span class="code-keyword">package</span> org.openremote.controller.protocol
global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;
global org.openremote.controller.statuscache.LevelFacade levels;
<span class="code-keyword">import</span> org.openremote.controller.protocol.*;
<span class="code-keyword">import</span> org.openremote.controller.model.event.*;
<span class="code-keyword">import</span> java.lang.<span class="code-object">Float</span>;
<span class="code-keyword">import</span> java.sql.Timestamp;
<span class="code-keyword">import</span> java.util.Date;
<span class="code-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-keyword">import</span> java.io.*;

rule <span class="code-quote">"mail jour"</span>
when
Event(source==<span class="code-quote">"DateTime isDay Sensor"</span>, value==<span class="code-quote">"<span class="code-keyword">true</span>"</span>)
then
execute.command(<span class="code-quote">"Send Mail jour"</span>);
end

rule <span class="code-quote">"mail nuit"</span>
when
Event(source==<span class="code-quote">"DateTime isDay Sensor"</span>, value==<span class="code-quote">"<span class="code-keyword">false</span>"</span>)
then
execute.command(<span class="code-quote">"Send Mail nuit"</span>);
end
</pre>
</div></div>

<p>That works now.</p>

<p>What a shame! </p>


</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by gman0105 at Feb 26, 2015 20:28
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596809"></a>
                                    <font class="smallfont"><p>Hi.<br/>
On which version, Pro or Free, works DateTime protocol and send e-mail?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aleksey_z at Feb 27, 2015 09:00
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596815"></a>
                                    <font class="smallfont"><p>It works for the free version.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by gman0105 at Feb 27, 2015 12:21
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23596816"></a>
                                    <font class="smallfont"><p>Hi.<br/>
Which version Java use? 1.6.0_38?<br/>
You just stopped the OR, deleted Java8,  installed Java6, launched the OR, and the rules work?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aleksey_z at Feb 27, 2015 13:21
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:34</font></td>
		    </tr>
	    </table>
    </body>
</html>