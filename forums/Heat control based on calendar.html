<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Heat control based on calendar</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Heat control based on calendar
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Oct 07, 2013 by <font color="#0050B2">thenetstriker</font>.
				    </div>

				    <p>I would like to configure a heating control using OpenRemote based on rules. But I don't just want to just set a fixed variable for the target temperature, I want to have a variable based on some sort of calendar where I can enter different events. (e.g. when I am home the temperature has to be higher as when I'am away or on vacation) Are there any examples on how a calendar can be accessed in such a way using OpenRemote rules?</p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-22877761"></a>
                                    <font class="smallfont"><p>Use timer cron syntax.</p>

<p>timer(cron: * * * * * ?)</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 08, 2013 07:32
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877762"></a>
                                    <font class="smallfont"><p>Second example of <a href="http://www.openremote.org/display/docs/Advanced+Rule+Examples" title="Advanced Rule Examples">Advanced Rule Examples</a> deals with the "vacation" thing. Maybe a good starting point?<br/>
Just for my curiosity: Do I interpret your post correctly that you want to get your "vacation data" from an external calendaring program?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Oct 08, 2013 08:10
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877766"></a>
                                    <font class="smallfont"><p>I already found those examples, but they are not exactly what I am looking for. I would like to get the events from e.g. one of my Google calendars and have the heat ajusted to the value (parsed from the title) of the current event. For the Google calendar there is a Phyton based library that could be used to get the events. Is is possible to call Phython libraries out of rules or is there some other way I could get the current event of my calendar in the rules?</p>

<p>Edit: There is also a Java based library to access Google calendar: <a href="https://developers.google.com/google-apps/calendar/v2/developers_guide_java">https://developers.google.com/google-apps/calendar/v2/developers_guide_java</a><br/>
Can maybe this library be used in the rules?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 08, 2013 08:48
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877768"></a>
                                    <font class="smallfont"><p>Here a newer v3 reference: <a href="https://developers.google.com/google-apps/calendar/v3/reference/">https://developers.google.com/google-apps/calendar/v3/reference/</a>. I am not a programmer so I can't say how complex it is to use. It looks as if one could use the http protocol to get events.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Oct 08, 2013 09:36
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877771"></a>
                                    <font class="smallfont"><p>You can use any Java API in Drools as it's Java based.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 08, 2013 10:04
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877779"></a>
                                    <font class="smallfont"><p>I did take a look at the Google Api and I think there might be a better solution. (Google api requests are limited as far as I now) I found some free calendar servers based on the CalDav protocol. There is also a CalDav library for java called CalDAV4j. I will take a look at this library if it can be accessed from a Drools rule.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 08, 2013 12:25
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877918"></a>
                                    <font class="smallfont"><p>I've tried different CalDav servers and different methods for reading the calendar events and I think the best solution would be to use the ical4j library and directly load the ical file. The ical4j library seams to have support for synchronisation or maybe even some sort of event system. (I'm not sure at the moment, the documentation of the library is not very good)</p>

<p>To choose the right method I need to know some facts about the possibities in drools:</p>
<ul class="alternate" type="square">
	<li>Is it possible to declare static objects in the java libraries? (So I don't have to parse the iCal file on every call)</li>
	<li>Is it possible to raise a rule based on an event from a java library in drools?</li>
</ul>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 10, 2013 13:34
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22877963"></a>
                                    <font class="smallfont"><p><tt>Is it possible to declare static objects in the java libraries? (So I don't have to parse the iCal file on every call)</tt></p>

<p>The answer is yes.</p>


<p><tt>Is it possible to raise a rule based on an event from a java library in drools?</tt></p>

<p>Have a look at following thread:
<a href="http://www.openremote.org/pages/viewpage.action?pageId=22877256&amp;focusedCommentId=22877947#comment-22877947">http://www.openremote.org/pages/viewpage.action?pageId=22877256&amp;focusedCommentId=22877947#comment-22877947</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 11, 2013 05:59
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878026"></a>
                                    <font class="smallfont"><p>Thanks for your help. I've managed it to create a java class which provides the current event and parses the temperature out of the event notes: <a href="http://pastebin.com/XR7aJRwL">http://pastebin.com/XR7aJRwL</a></p>

<p>I've copied this class in a jar file and the files ical4j-1.0.5.jar, backport-util-concurrent-3.1.jar, commons-lang-2.6.jar and commons-logging-1.1.3.jar to webapps/controller/WEB-INF/lib. Now I am able to get the current target temperature using this drl code: <a href="http://pastebin.com/b2jXsThp">http://pastebin.com/b2jXsThp</a></p>

<p>Now I have some addidional questions:<br/>
1) How can I display the value of Temperature.getTargetTemperature() on the UI?<br/>
2) My current Java class cannot trace changes in the ical file. In Java 7 there is a new function called WatchService which would be perfect to monitor changes in the ical file. When will Java 7 be supported by OpenRemote?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 12, 2013 17:50
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878043"></a>
                                    <font class="smallfont"><blockquote><p>1) How can I display the value of Temperature.getTargetTemperature() on the UI?</p></blockquote>
<p>You can use Sensor.update(val) in the rule which should be attached to a label in the UI.</p>

<blockquote><p>2) My current Java class cannot trace changes in the ical file. In Java 7 there is a new function called WatchService which would be perfect to monitor changes in the ical file. When will Java 7 be supported by OpenRemote?</p></blockquote>
<p>People have been reporting using JDK8 on RPi. Not sure what's the problem you are facing while using JRE7.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 13, 2013 07:30
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878073"></a>
                                    <font class="smallfont"><p>I found a constructor for the Sensor class, but it needs multiple parameters. Can you provide a simple example on how I can get a reference to a sensor in a drools rule? And how do I have to configure the sensor? (Do I have to set a dummy command to the sensor?)<br/>
Can you also provide a simple example on how I can handle a simple button click on the UI using a drools rule? And do I have to configure a dummy command to handle the click? (Until I found a good solution to trigger a rule on changes in the calendar I'd like to add a button to reload the calendar)</p>

<p>I don't use Java 7 because the drools rules don't work at all whit this version. Here is the error i get:</p>

<p>ERROR 2013-10-13 14:28:15,365 : Cannot start event processor 'Drools Rule Engine' : Unable to load dialect 'org.drools.rule.builder.dialect.java.JavaDialectConfiguration:java:org.drools.rule.builder.dialect.java.JavaDialectConfiguration'<br/>
org.drools.RuntimeDroolsException: Unable to load dialect 'org.drools.rule.builder.dialect.java.JavaDialectConfiguration:java:org.drools.rule.builder.dialect.java.JavaDialectConfiguration'<br/>
	at org.drools.compiler.PackageBuilderConfiguration.addDialect(PackageBuilderConfiguration.java:283)<br/>
	at org.drools.compiler.PackageBuilderConfiguration.buildDialectConfigurationMap(PackageBuilderConfiguration.java:268)<br/>
	at org.drools.compiler.PackageBuilderConfiguration.init(PackageBuilderConfiguration.java:181)<br/>
	at org.drools.compiler.PackageBuilderConfiguration.&lt;init&gt;(PackageBuilderConfiguration.java:159)<br/>
	at org.drools.compiler.PackageBuilder.&lt;init&gt;(PackageBuilder.java:210)<br/>
	at org.drools.compiler.PackageBuilder.&lt;init&gt;(PackageBuilder.java:143)<br/>
	at org.drools.builder.impl.KnowledgeBuilderFactoryServiceImpl.newKnowledgeBuilder(KnowledgeBuilderFactoryServiceImpl.java:34)<br/>
	at org.drools.builder.KnowledgeBuilderFactory.newKnowledgeBuilder(KnowledgeBuilderFactory.java:47)<br/>
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:484)<br/>
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)<br/>
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)<br/>
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)<br/>
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)<br/>
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)<br/>
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)<br/>
	at org.openremote.controller.service.Deployer.startup(Deployer.java:858)<br/>
	at org.openremote.controller.service.Deployer.startController(Deployer.java:336)<br/>
	at org.openremote.controller.spring.SpringContext.initializeController(SpringContext.java:109)<br/>
	at org.openremote.controller.service.ServiceContext.init(ServiceContext.java:383)<br/>
	at org.openremote.controller.bootstrap.Startup.loadServiceContext(Startup.java:85)<br/>
	at org.openremote.controller.bootstrap.servlet.ServletStartup.initializeServiceContext(ServletStartup.java:190)<br/>
	at org.openremote.controller.bootstrap.servlet.ServletStartup.contextInitialized(ServletStartup.java:109)<br/>
	at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:3843)<br/>
	at org.apache.catalina.core.StandardContext.start(StandardContext.java:4342)<br/>
	at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase.java:791)<br/>
	at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:771)<br/>
	at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)<br/>
	at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.java:926)<br/>
	at org.apache.catalina.startup.HostConfig.deployDirectories(HostConfig.java:889)<br/>
	at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492)<br/>
	at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1149)<br/>
	at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java:311)<br/>
	at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(LifecycleSupport.java:117)<br/>
	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053)<br/>
	at org.apache.catalina.core.StandardHost.start(StandardHost.java:719)<br/>
	at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1045)<br/>
	at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:443)<br/>
	at org.apache.catalina.core.StandardService.start(StandardService.java:516)<br/>
	at org.apache.catalina.core.StandardServer.start(StandardServer.java:710)<br/>
	at org.apache.catalina.startup.Catalina.start(Catalina.java:578)<br/>
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)<br/>
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br/>
	at java.lang.reflect.Method.invoke(Method.java:606)<br/>
	at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:288)<br/>
	at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)<br/>
Caused by: org.drools.RuntimeDroolsException: value '1.7' is not a valid language level<br/>
	at org.drools.rule.builder.dialect.java.JavaDialectConfiguration.getDefaultLanguageLevel(JavaDialectConfiguration.java:162)<br/>
	at org.drools.rule.builder.dialect.java.JavaDialectConfiguration.init(JavaDialectConfiguration.java:57)<br/>
	at org.drools.compiler.PackageBuilderConfiguration.addDialect(PackageBuilderConfiguration.java:279)</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 13, 2013 15:35
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878097"></a>
                                    <font class="smallfont"><p>On second thoughts, you might not be able to update sensors from rule engine. However, you can trigger the action from UI using this logic. Define a new sensor in UI using a virtual command. A sensor can be identified using the event source. You can write something like:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"> 
When
  Event(source == <span class="code-quote">"sensorname"</span>, value == <span class="code-quote">"on"</span>)
Then
  <span class="code-comment">// <span class="code-keyword">do</span> something
</span>End
</pre>
</div></div>


<p>For supporting JRE 1.7, looks like Drools have to be upgraded. <a href="http://www.openremote.org/pages/viewpage.action?pageId=22877075&amp;focusedCommentId=22878077#comment-22878077">Check this.</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 14, 2013 07:19
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878148"></a>
                                    <font class="smallfont"><p>The JRE 1.7 fix worked, I will see if the filesystem event also works. Thanks for the link!</p>

<p>Edit: I've managed it to implement a button to manually refresh the calendar. I had to add three virtual commands (for on, off and status) and a sensor for the status command. Now my buttons executes the on command and my rule refreshes the calendar and executes the off command. Using this configuration the user can double click on the button and the command is only executed once. Here is my new rule:</p>

<p>rule "Reload calendar switch click"<br/>
	when<br/>
	    e : Event( source == "SE_ReloadCalendar", value == "on" )<br/>
	    t : Temperature ( )<br/>
	then<br/>
		CalendarProvider.loadCalendarFromUrl(t.getCalendarUrl(), t.getCalendarUsername(), t.getCalendarPassword());<br/>
		execute.command("ReloadCalendarOff");<br/>
end</p>

<p>I also have another idea of how I might be able to set a sensor value from a rule. I've managed it to get a reference to the KnowledgeRuntime of drools:</p>

<p>In the rule I just call:<br/>
CalendarProvider.Test(drools.getKnowledgeRuntime());</p>

<p>And here is the test function:<br/>
public static void Test(final KnowledgeRuntime knowledgeRuntime) {<br/>
    	Collection&lt;Object&gt; objects = knowledgeRuntime.getObjects();</p>

<p>    	for (Object obj : objects) {</p>

<p>    	}<br/>
    }</p>

<p>In "getObject" I only find my "Temperature" object. Can I somehow get a reference to the configured sensors using this KnowledgeRuntime?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 14, 2013 13:26
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878211"></a>
                                    <font class="smallfont"><p>No, you can't get a reference to sensor without some programming. And if you are willing to code, I suggest you write a command and a commandBuilder implementation for a new email protocol.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 15, 2013 13:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878250"></a>
                                    <font class="smallfont"><p>Thanks for the hint, I made a simple change to the VirtualCommand.java. I've just added this function to the class:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">public</span> <span class="code-keyword">static</span> void setValue(<span class="code-object">String</span> address, <span class="code-object">String</span> value) {
    virtualDevices.put( address, value );
}
</pre>
</div></div>

<p>Now I can configure a virtual command with an address and command "status" and setup a custom sensor which provides a value for a label on the webinterface. Then I can set the desired value in my rule using this command:<br/>
org.openremote.controller.protocol.virtual.VirtualCommand.setValue("address", "value");</p>

<p>The value is immediately displayed on the webinteface. Would it make sense to implement this function in the next release of openremote?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 15, 2013 19:46
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878284"></a>
                                    <font class="smallfont"><p>Glad to hear that it worked for you. However, I don't think this can be included (modification to VirtualCommand) in the distribution as it doesn't conform to OR framework. As I said earlier, if you can write an ExecutableCommand (also EventProducer) implementation, it can surely be included in OR.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Oct 16, 2013 06:53
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22878582"></a>
                                    <font class="smallfont"><p>I've just found out that it is also possible to set the values from a command without my modification. Just call execute.command("MyVirtualCommand", "MyValue") from any rule, so there is no need for a new Command.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by thenetstriker at Oct 21, 2013 15:30
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:41</font></td>
		    </tr>
	    </table>
    </body>
</html>