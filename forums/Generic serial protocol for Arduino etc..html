<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Generic serial protocol for Arduino etc.</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Generic serial protocol for Arduino etc.
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on May 25, 2013 by <font color="#0050B2">lawrie</font>.
				    </div>

				    <p>Would adding a generic serial protocol be a good idea? I am thinking mainly of the case of integrating with Arduino-based controllers and possibly sensors. The parameters for such a protocol would be something like, com port, data rate and message in hex. </p>

<p>I have several Arduino based controllers that this would work for, using USB connections. For example I have one that sends IR codes. I have code for this in my HouseControl project and code easily contribute it.  </p>

<p>I am not sure how sensors would work as they would need some decoding of incoming data and triggering of the relevant OR sensor.</p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-22414958"></a>
                                    <font class="smallfont"><p>Yes would be happy to see this as a contribution.</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at May 25, 2013 16:32
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22873041"></a>
                                    <font class="smallfont"><p>This would at once be a proper solution for a Velbus-integration! </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by helsenbe at Jun 18, 2013 21:40
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22873570"></a>
                                    <font class="smallfont"><p>Hi Juha,</p>

<p>Can you add this XML to the staging designer for this protocol, please:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-xml">
<span class="code-tag">&lt;?xml version=<span class="code-quote">"1.0"</span> encoding=<span class="code-quote">"UTF-8"</span>?&gt;</span>

&lt;!--

 OpenRemote, the Home of the Digital Home.
 Copyright 2008-2013, OpenRemote Inc.

 See the contributors.txt file in the distribution for a
 full listing of individual contributors.

 This is free software; you can redistribute it and/or modify it
 under the terms of the GNU General Public License as
 published by the Free Software Foundation; either version 3.0 of
 the License, or (at your option) any later version.

 This software is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

 You should have received a copy of the GNU General Public
 License along with this software; if not, write to the Free
 Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 02110-1301 USA, or see the FSF site: http://www.fsf.org.

--&gt;

&lt;!--
 |  Generic serial protocol configuration for OpenRemote Designer.
 |
 |  Author: Lawrie Griffiths
 +--&gt;
&lt;openremote xmlns=<span class="code-quote">"http://www.openremote.org"</span> <span class="code-keyword">xmlns:xsi</span>=<span class="code-quote">"http://www.w3.org/2001/XMLSchema-instance"</span>
	xsi:schemaLocation=<span class="code-quote">"http://www.openremote.org protocol.xsd"</span>&gt;
	<span class="code-tag">&lt;protocol displayName=<span class="code-quote">"Serial"</span> tagName=<span class="code-quote">"serial"</span>&gt;</span>
		<span class="code-tag">&lt;attr name=<span class="code-quote">"port"</span> label=<span class="code-quote">"COM port"</span>&gt;</span>
			<span class="code-tag">&lt;validations&gt;</span>
				<span class="code-tag">&lt;allowBlank&gt;</span>false<span class="code-tag">&lt;/allowBlank&gt;</span>
			<span class="code-tag">&lt;/validations&gt;</span>
		<span class="code-tag">&lt;/attr&gt;</span>
		<span class="code-tag">&lt;attr name=<span class="code-quote">"rate"</span> label=<span class="code-quote">"Data rate (bps)"</span>&gt;</span>
			<span class="code-tag">&lt;validations&gt;</span>
				<span class="code-tag">&lt;allowBlank&gt;</span>false<span class="code-tag">&lt;/allowBlank&gt;</span>
				<span class="code-tag">&lt;regex message=<span class="code-quote">"Data rate must be an integer"</span>&gt;</span>\d+<span class="code-tag">&lt;/regex&gt;</span>
			<span class="code-tag">&lt;/validations&gt;</span>
		<span class="code-tag">&lt;/attr&gt;</span>
		<span class="code-tag">&lt;attr name=<span class="code-quote">"command"</span> label=<span class="code-quote">"Command"</span>&gt;</span>
			<span class="code-tag">&lt;validations&gt;</span>
				<span class="code-tag">&lt;allowBlank&gt;</span>false<span class="code-tag">&lt;/allowBlank&gt;</span>
			<span class="code-tag">&lt;/validations&gt;</span>
		<span class="code-tag">&lt;/attr&gt;</span>
	<span class="code-tag">&lt;/protocol&gt;</span>
<span class="code-tag">&lt;/openremote&gt;</span>
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by lawrie at Jul 03, 2013 09:52
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22873574"></a>
                                    <font class="smallfont"><p>Done!</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at Jul 03, 2013 10:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22873647"></a>
                                    <font class="smallfont"><p>I have committed a first version of this to my workspace in SVN.</p>

<p>Here is an example Arduino sketch, which uses this protocol and my library (available on Github) to control LightwaveRF devices with an Arduino and a cheap RF 434Mhz transmitter:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
#include &lt;LightwaveRF.h&gt;
                     
<span class="code-object">byte</span> myid[] = {0x6F,0xEB,0xBE,0xED,0xB7,0x7B};

void setup() {
  lw_setup();
  Serial.begin(9600);
}

void loop() {
  <span class="code-keyword">if</span> (Serial.available()) {
    <span class="code-object">char</span> c1 = Serial.read();
    <span class="code-keyword">while</span>(!Serial.available());
    <span class="code-object">char</span> c2 = Serial.read();
   
    <span class="code-keyword">if</span> (c2 &gt;= '0' &amp;&amp; c2 &lt;= '9') { <span class="code-comment">// device number
</span>      <span class="code-object">byte</span> d = c2 - '0';
      <span class="code-keyword">if</span> (c1 =='1') {
        Serial.println(<span class="code-quote">"Switch device on"</span>);
        lw_cmd(0,d,LW_ON,myid);
      } <span class="code-keyword">else</span> <span class="code-keyword">if</span> (c1 == '0') {
        Serial.println(<span class="code-quote">"Switch device off"</span>);
        lw_cmd(0,d,LW_OFF,myid);
      }
    }
  }
}
</pre>
</div></div>

<p>The implementation of the protocol is similar to the existing TCP/IP socket protocol, except that it keeps the serial connections open. It handles sensors by polling for the data, rather than using an event listener. I am not sure if an event listener implementation would be better. </p>

<p>And here is an example of a sensor getting the power reading from an OpenEnergyMonitor emonTx using a Jeelink or similar device that runs Jeelib:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
#include &lt;JeeLib.h&gt;
#include &lt;avr/eeprom.h&gt;
#include &lt;util/crc16.h&gt;

#define SERIAL_BAUD 57600
#define COLLECT 0x20 <span class="code-comment">// collect mode, i.e. pass incoming without sending acks
</span>
#define EMONTX_NODE 10
<span class="code-comment">// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span><span class="code-comment">// RF12 configuration setup code
</span>
typedef struct {
    <span class="code-object">byte</span> nodeId;
    <span class="code-object">byte</span> group;
    <span class="code-object">char</span> msg[RF12_EEPROM_SIZE-4];
    word crc;
} RF12Config;

<span class="code-keyword">static</span> RF12Config config;
<span class="code-keyword">static</span> <span class="code-object">int</span> power;

void setup() {
    Serial.begin(SERIAL_BAUD);

    <span class="code-keyword">if</span> (rf12_config(0)) {
        config.nodeId = eeprom_read_byte(RF12_EEPROM_ADDR);
        config.group = eeprom_read_byte(RF12_EEPROM_ADDR + 1);
    } <span class="code-keyword">else</span> {
        Serial.print(<span class="code-quote">"No configuration"</span>);
    }
}

void loop() {   
    <span class="code-keyword">if</span> (Serial.available()) {
      <span class="code-keyword">if</span> (Serial.read() == 'p') { 
        Serial.println(power);
      }
    }
    
    <span class="code-keyword">if</span> (rf12_recvDone()) {
        <span class="code-object">byte</span> n = rf12_len;
        <span class="code-keyword">if</span> (rf12_crc == 0) {    
            <span class="code-object">byte</span> node = (rf12_hdr &amp; 0x1f);
            <span class="code-keyword">if</span> (node == EMONTX_NODE) { 
              power = (rf12_data[0] + (rf12_data[1] &lt;&lt; 8));;
            }
            <span class="code-keyword">if</span> (RF12_WANTS_ACK &amp;&amp; (config.nodeId &amp; COLLECT) == 0) {
                rf12_sendStart(RF12_ACK_REPLY, 0, 0);
            }
        } 
    }
}
</pre>
</div></div>

</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by lawrie at Jul 05, 2013 09:38
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23593839"></a>
                                    <font class="smallfont"><p>Hi</p>

<p>I'm new to OpenRemote and would really appreciate some help.</p>

<p>I import and support the whole Velbus range of home automation modules and would really like to offer some of my clients a more flexible remote interface that supports additional protocols, like the iTach modules.</p>

<p>Is there anywhere I can go to read up on how to get the Velbus system working with OpenRemote.</p>

<p>Many thanks</p>

<p>Stuart</p>

<p>www.mdar.co.uk</p>

<p>UK importer of Velbus modules.<br/>
www.velbus.eu/products</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mdar at Nov 18, 2014 17:50
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23594431"></a>
                                    <font class="smallfont"><p>hello </p>

<p>I have tested the UART (Serial) communication, with FTDI device, between arduino uno and openremote on windows but it doesn't work.<br/>
The led, on arduino board, don't flash when I send data from OR to Arduino UNO that is why I think I have a problem with OR.<br/>
Does anyone have an idea to resolve it ?</p>

<p>Thanks</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by lionel81 at Dec 05, 2014 17:33
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23600090"></a>
                                    <font class="smallfont"><p>Hi</p>

<p>You might be interested to know that the Full Velbus protocol is being integrated into OpenRemote <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>I've just got some 'proving out' of the 61 core commands to do first.</p>

<p>The plan is to add full functionality to the Demo OpenRemote composer, but limit the amount of modules it will work with to 5.<br/>
At the same time to add unlimited functionally to OpenRemote Pro.</p>


<p>We'll make a public announcement very soon <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>


<p>Cheers</p>

<p>Stuart</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mdar at Jul 10, 2015 15:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-23601381"></a>
                                    <font class="smallfont"><p>Not sure but I guess OR will open/close serial comm once the command is triggered. In this case it will reset the Arduino. Confirm this please.</p>

<p>Anyway, Try to use a Serial/IP bridge, make one yourself in Python. Java is a PITA for Serial.<br/>
I only use Arduino MEGA with Ethernet Shield talking with OR via UDP. Somethings I even don't send direct to OR, The Arduino stream UDP to a Phyton server to process and then send to OR through UDP too. <br/>
Works like a charm, fast and reliable. </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by rberg at Sep 22, 2015 01:48
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:30</font></td>
		    </tr>
	    </table>
    </body>
</html>