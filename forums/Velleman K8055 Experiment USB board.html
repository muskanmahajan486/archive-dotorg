<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Velleman K8055 Experiment USB board</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Velleman K8055 Experiment USB board
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Mar 14, 2012 by <font color="#0050B2">demo</font>.
				    </div>

				    <p>Hi,</p>

<p>Many time ago I've bought the popular Velleman K8055 Experiment board, it uses an USB port and shows as a tty (or com on win).</p>

<p>The question is: what are the chances to use that board with OpenRemote ?</p>

<p>I already did a search in the forum and it doesn't found any terms just one post about "Using USB I/O controller board".</p>


<p>Any help is appreciate.</p>

<p>Thx</p>

<p>&#8212;<br/>
Max</p>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">Attachments:</a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/19439745/19398820.jpg">Immagine.JPG</a> (image/jpeg)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/19439745/19398821.jpg">Immagine2.JPG</a> (image/jpeg)
                                <br/>
                                                    </div>
				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-19439751"></a>
                                    <font class="smallfont"><p>If you are a Java developer, you can create your own protocol to communicate with the board.<br/>
For now we use RXTX for Java to serial communication but we also work on something more flexible.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Mar 15, 2012 06:38
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19439752"></a>
                                    <font class="smallfont"><p>Hello Marcus and thank you to point me in the right direction.</p>

<p>But I have not experience with Java developing, just a little knowledge.</p>

<p>I found someone already wrote a Java protocol to drive the board (the project is at <a href="http://sourceforge.net/projects/k8055-x64-java">http://sourceforge.net/projects/k8055-x64-java</a>) and it's based on the original protocol that come with the board, a .dll for windows programmers.</p>

<p>So, what should be the right way: integrate the existent one or write a new protocol from scratch ?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Mar 15, 2012 09:16
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19439753"></a>
                                    <font class="smallfont"><p>The project you mentioned above is using Java native interface which is not ideal.<br/>
But here (<a href="http://libk8055.sourceforge.net/">http://libk8055.sourceforge.net/</a>) they mention a command line interface.</p>

<p>OpenRemote supports a command line protocol which should already do the job, but in the moment it's only for triggering actions and not read back output from the called command.</p>

<p>You could try if that can already help you.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Mar 15, 2012 09:22
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19439757"></a>
                                    <font class="smallfont"><p>As you told the command line protocol is not good for sensors data collecting.</p>

<p>So, I realize the best way remain to write down a new protocol as it was discuss in this post <a href="http://www.openremote.org/display/forums/Controlling+a+USB+based+controller+board">http://www.openremote.org/display/forums/Controlling+a+USB+based+controller+board</a></p>

<p>Many thx.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Mar 15, 2012 17:56
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440373"></a>
                                    <font class="smallfont"><p>As opposed side of the previous conclusion I took the time to experiment with OpenRemote and a simple PHP wrapper script for the k8055 command line on a CentOS box.</p>

<p>The PHP script run under Apache and accepts URL parameters used to control and retrieve the k8055 digital output status.</p>

<p>Then in the OR Composer-&gt;Building Modeler I did the configuration for every one of eight (8) k8055 digital outputs as the following one x 8:</p>

<p>http command<br/>
name "D1 On"<br/>
URL  "http://128.0.0.1/automation/cmd.php?cmd=on&amp;digital=1"</p>

<p>http command<br/>
name "D1 Off"<br/>
URL  "http://128.0.0.1/automation/cmd.php?cmd=off&amp;digital=1"</p>

<p>http command<br/>
name    "D1 Status"<br/>
URL     "http://128.0.0.1/automation/cmd.php?cmd=status&amp;digital=1" (return On or Off)<br/>
Polling "1s"</p>

<p>Sensor<br/>
name    "D1 Sensor"<br/>
command "D1 Status"<br/>
type    "Switch"</p>

<p>Switch<br/>
name        "D1 Switch"<br/>
sensor      "D1 Sensor"<br/>
command on  "D1 On"<br/>
command off "D1 Off"</p>


<p>In the OR Composer-&gt;UI Designer I did a new panel with 8 switchs configured to use the 8 switch elements made in Building Modeler.</p>

<p>At the end of the configurations I saved all work and synced it on OR Controller.</p>

<p>Now I'm able to use the panel on an Android phone and on OR Web Console. Amazing!</p>


<p>But problems doesn't wait to come <img class="emoticon" src="images/icons/emoticons/sad.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>This kind of solution is CPU time consuming.</p>

<p>Tailing the Apache access_log I can see all eight (8) HTTP requests made by OR Controller to check the Switch status.</p>

<p>Java process and Apache are consuming 5% to 10% of the CPU time on a Pentium 4 3Ghz HT.</p>

<p>For any On/Off/Status request (at least 8 requests each 1s) thet system executes the following chain of processes:</p>

<p>OR Controller (via HTTP)&gt;&gt; Apache &gt;&gt; PHP (function shell_exec)&gt;&gt; k8055cmd (via libusb)&gt;&gt; K8055 Board</p>

<p>So, I'm looking for a solution to reducing the number of status requests without to reduce the polling time of every sensors.</p>

<p>Since it is possible for me to retrieve all digital status with just one HTTP request, a workaround would be possible configuring a Virtual Sensor for every Switch. Then, configuring an OR Rule in which there is just one HTTP status request followed by a Rule Action. The Rule Action should elaborates the HTTP responses and updates the values of every Virtual Sensors.</p>


<p>Would it be possible?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Apr 25, 2012 08:51
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440374"></a>
                                    <font class="smallfont"><p>The best way would be OpenRemote talking to the k8055cmd which would mean no more Apache and PHP needed.<br/>
That should already bring down CPU consumption.</p>

<p>Do you have a sample command line call and the result (maybe a console screenshot)? The PHP wrapper would be helpfull also.<br/>
Maybe I can quickly add support to read command line outcome.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 25, 2012 09:09
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440376"></a>
                                    <font class="smallfont"><p>Hello Marcus and thank you for your valuable support.</p>

<p>I appreciate it very much <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>


<p>About the k8055 board there are many projects with different way of communications.</p>

<p>At this time I'm using k8055utils found at <a href="http://k8055utils.sourceforge.net">http://k8055utils.sourceforge.net</a>.</p>

<p>k8055utils provides a daemon (k8055d) and two clients: k8055m and k8055s.</p>

<p>k8055d monitors up to four k8055 USB interface boards.</p>

<p>k8055m controls or observes k8055d via Shared Memory.</p>

<p>k8055s controls or observes k8055d via Sockets.</p>


<p>This is how command line functions.<br/>
<a class="confluence-thumbnail-link 792x244" href='http://www.openremote.org/download/attachments/19439745/Immagine.JPG'><img src="attachments/thumbnails/19439745/19398820" align="absmiddle" border="0"/></a></p>



<p>This is a shell script executed on the command line.<br/>
<a class="confluence-thumbnail-link 794x260" href='http://www.openremote.org/download/attachments/19439745/Immagine2.JPG'><img src="attachments/thumbnails/19439745/19398821" align="absmiddle" border="0"/></a></p>




<p>This is a simple PHP script I did in order to manage the board through OR.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
&lt;?php

$_request = $_GET['cmd'];
$_digital = $_GET['digital'];

<span class="code-keyword">switch</span> ($_request) {

        <span class="code-keyword">case</span> 'on':
                $_cmd = '<span class="code-keyword">if</span> [ $[`k8055m 1c`] == 1 ]; then k8055m 1d'.$_digital.'=1; fi;';
                $_response = shell_exec($_cmd);
                <span class="code-keyword">break</span>;
        <span class="code-keyword">case</span> 'off':
                $_cmd = '<span class="code-keyword">if</span> [ $[`k8055m 1c`] == 1 ]; then k8055m 1d'.$_digital.'=0; fi;';
                $_response = shell_exec($_cmd);
                <span class="code-keyword">break</span>;
        <span class="code-keyword">case</span> 'status':
                $_cmd = '<span class="code-keyword">if</span> [ $[`k8055m 1c`] == 1 ]; then k8055m 1od'.$_digital.'; fi;';
                $_response = shell_exec($_cmd);
                <span class="code-keyword">break</span>;
}

$_output = (($_response == 1) ? 'on': 'off');

echo $_output;

?&gt;
</pre>
</div></div>


<p>The k8055d daemon accepts even connections through its socket but it seems not to be a text plain communication used only by its client k8055s.</p>


<p>Please let me know if that help or integrations are required.</p>

<p>Thanks.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Apr 25, 2012 14:51
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440388"></a>
                                    <font class="smallfont"><p>That should help, thanks.<br/>
I already started on integrating status from the command line and should be able to send you something tonight or 2morrow.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 25, 2012 16:28
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440393"></a>
                                    <font class="smallfont"><p>Hi Max,<br/>
I updated the ShellExe protocol to return the result of the command line call as String. You should be able to create the status call as a ShellExe command now and assign a switch sensor. I also added the "pollingInterval" and "regex" attribute to slow down the reader thread and to be able to use a regular expression to parse the result.</p>

<p>You can find a modified version of the 2.0 controller here: <a href="http://www.redeker-consulting.de/openremote/OpenRemote-Controller-2.0.0.zip">http://www.redeker-consulting.de/openremote/OpenRemote-Controller-2.0.0.zip</a></p>

<p>Since the online designer does not support the 2 extra attributes (pollingInterval, regex) for the ShellExe command, you will have to edit your controller.xml file manually, if you want to use this.</p>

<p>Let me know how it goes.</p>

<p>--Marcus</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 25, 2012 23:16
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440400"></a>
                                    <font class="smallfont"><p>Great job Marcus.</p>

<p>It works as expected, ShellExe command too.</p>

<p>By excluding Apache/PHP layer now the CPU has a constant load = 3% without using any regex.</p>

<p>Nice, It is better of before! <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>But as the first test was done I did another test doubling the number of sensors, from 8 to 16.</p>

<p>The result is a double CPU load (6%) ! That don't like me <img class="emoticon" src="images/icons/emoticons/sad.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Since the OR Sensors are used even for Switch and not just for sensors, what if OR have to poll many devices like 30 or 50 sensors and more?</p>

<p>I understand that the polling technique is required since a complete stateful architecture is not possible using different interfaces, needed to manage all supported devices.</p>

<p>So, it would be very helpful usign Virtual Sensors in combination with the Rule logic as I already mention above.</p>

<p>Reducing the number of poll request should be a prioritary objective.</p>

<p>Else cheaper system shouldn't be enough.</p>

<p>What do you think about?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Apr 26, 2012 08:29
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440403"></a>
                                    <font class="smallfont"><p>As I understand it should be possible to request all switch status using only one command.<br/>
Would you be able to create some kind of regex to extract from one result the status for each switch?</p>

<p>This way you only need one command (with extra extraction instructions) and bind all 16 sensors to the same command. This results in only one thread.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 26, 2012 10:52
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440407"></a>
                                    <font class="smallfont"><p>sorry, read below.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Apr 26, 2012 12:49
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440408"></a>
                                    <font class="smallfont"><p>Yes, right as I told.</p>

<p>I can get a response like this:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
off off off off off off off off
</pre>
</div></div>

<p>The regex would be:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s
</pre>
</div></div>

<p>Now all single results are in the regex var groups:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
\1	first group = digital out 1 = on or off
\2	second...
\3	...
\4	...
\5	...
\6	...
\7	...
\8	...
</pre>
</div></div>
<p>How to bind all sensors to the same command?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at Apr 26, 2012 12:49
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440410"></a>
                                    <font class="smallfont"><p>Ok, thanks.<br/>
It's just an idea for now but we will look into this.<br/>
You can already create multiple sensors and always use the same status command.<br/>
It's just the possibilty to add a regex to distribute the command result onto the sensors, which is missing.<br/>
I will let you know, what we come up with.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 26, 2012 13:21
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440483"></a>
                                    <font class="smallfont"><p>Ok, I created a version of the ShellExe command which can be used as discussed with multiple sensors linked to the same command.<br/>
The download is the same as in the post above: <a href="http://www.redeker-consulting.de/openremote/OpenRemote-Controller-2.0.0.zip">http://www.redeker-consulting.de/openremote/OpenRemote-Controller-2.0.0.zip</a></p>

<p>The controller.xml should look like this:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
  &lt;sensors&gt;
    &lt;sensor id=<span class="code-quote">"15"</span> name=<span class="code-quote">"a2"</span> type=<span class="code-quote">"<span class="code-keyword">switch</span>"</span>&gt;
      &lt;include type=<span class="code-quote">"command"</span> ref=<span class="code-quote">"17"</span> /&gt;
      &lt;state name=<span class="code-quote">"on"</span> /&gt;
      &lt;state name=<span class="code-quote">"off"</span> /&gt;
    &lt;/sensor&gt;
    &lt;sensor id=<span class="code-quote">"16"</span> name=<span class="code-quote">"a1"</span> type=<span class="code-quote">"<span class="code-keyword">switch</span>"</span>&gt;
      &lt;include type=<span class="code-quote">"command"</span> ref=<span class="code-quote">"17"</span> /&gt;
      &lt;state name=<span class="code-quote">"on"</span> /&gt;
      &lt;state name=<span class="code-quote">"off"</span> /&gt;
    &lt;/sensor&gt;
  &lt;/sensors&gt;
  &lt;commands&gt;
    &lt;command id=<span class="code-quote">"17"</span> protocol=<span class="code-quote">"shellexe"</span>&gt;
      &lt;property name=<span class="code-quote">"commandParams"</span> value=<span class="code-quote">"/Users/marcus/test.txt"</span> /&gt;
      &lt;property name=<span class="code-quote">"regex"</span> value=<span class="code-quote">"(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)"</span> /&gt;
      &lt;property name=<span class="code-quote">"pollingInterval"</span> value=<span class="code-quote">"20s"</span> /&gt;
      &lt;property name=<span class="code-quote">"commandPath"</span> value=<span class="code-quote">"cat"</span> /&gt;
      &lt;property name=<span class="code-quote">"name"</span> value=<span class="code-quote">"a"</span> /&gt;
    &lt;/command&gt;
  &lt;/commands&gt;
</pre>
</div></div>

<p>If your regex creates 8 var groups you can link 8 sensors to the same command.</p>

<p>The java code used looks like this:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
Pattern regexPattern = Pattern.compile(regex);
Matcher matcher = regexPattern.matcher(readValue);
<span class="code-keyword">if</span> (matcher.find()) {
  <span class="code-keyword">for</span> (<span class="code-object">int</span> i = 0; i &lt; sensors.size(); i++) {
    sensors.get(i).update(matcher.group(i+1));
  }
}
</pre>
</div></div>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 30, 2012 14:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19440501"></a>
                                    <font class="smallfont"><p>Thank you Marcus,</p>

<p>it does the trick but there is a problem with the panel's sensors order that doesn't match the sensors order referenced by sensors.get() method.</p>

<p>For example, if I click on the switch number 1, it executes the the right commands but the related sensors changes the state of switch number 5.</p>

<p>I have also double checked the group values returned by regex, the "Regular Expression Test" shows me 8 groups ordered from 1 to 8 with the related values for each group. So, the matcher.group(i+1) should be right.</p>

<p>I have tried to change the xml element's order but it doesn't help.</p>

<p>Maybe the code should refereces every sensors by its object ID and not by the index array returned by sensors.size() method. That way it should use the right sensor.</p>

<p>What do you think about that?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 02, 2012 11:51
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988487"></a>
                                    <font class="smallfont"><p>In my test the order of sensors were ok, but I guess it depends on how you link them online and also the Designer might export them in a different order.<br/>
We would have to find a way to link the RegEx group to the sensor name. Then we would be on the safe side. The id from the xml does not help since that is generated by the designer and can change.<br/>
We could use an extra attribute "sensorLink" which takes a string like this sensorName:1,sensorName:2,....</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 03, 2012 11:13
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988740"></a>
                                    <font class="smallfont"><p>after a while finally I found the time and the understanding to change something in the following files:</p>

<p>/Controller/src/org/openremote/controller/protocol/shellexe/ShellExeCommand.java
<a href="http://pastebin.com/zKgrEwiV">http://pastebin.com/zKgrEwiV</a></p>

<p>/Controller/src/org/openremote/controller/protocol/shellexe/ShellExeCommandBuilder.java
<a href="http://pastebin.com/3zFQztnd">http://pastebin.com/3zFQztnd</a></p>

<p>In order to associate sensors'names with regex groups the command in the controller.xml file should contains a new property named "sensorsNamesList".<br/>
It accepts a list of names separated by a semicolon character like in this example:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
&lt;command id=<span class="code-quote">"17"</span> protocol=<span class="code-quote">"shellexe"</span>&gt;
  &lt;property name=<span class="code-quote">"commandParams"</span> value=<span class="code-quote">"/Users/marcus/test.txt"</span> /&gt;
  &lt;property name=<span class="code-quote">"regex"</span> value=<span class="code-quote">"(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)\s(on|off)"</span> /&gt;
  &lt;property name=<span class="code-quote">"sensorsNamesList"</span> value=<span class="code-quote">"a;b;c;d;e;f;g;h"</span> /&gt;
  &lt;property name=<span class="code-quote">"pollingInterval"</span> value=<span class="code-quote">"20s"</span> /&gt;
  &lt;property name=<span class="code-quote">"commandPath"</span> value=<span class="code-quote">"cat"</span> /&gt;
  &lt;property name=<span class="code-quote">"name"</span> value=<span class="code-quote">"a"</span> /&gt;
&lt;/command&gt;
</pre>
</div></div>

<p>There's just a problem <img class="emoticon" src="images/icons/emoticons/sad.gif" height="20" width="20" align="absmiddle" alt="" border="0"/> I can't compile the code because my environment is wrong and I got many errors.<br/>
Can you do it for me?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 18, 2012 18:50
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988742"></a>
                                    <font class="smallfont"><p>Ok, I commited the change in my Controller_2_0_0_Fixes branch and uploaded a new controller version to my webside. <br/>
Same link as above.</p>

<p>I changed the code in that way that the attribute is now called "sensorNamesList". I removed one 's' <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/><br/>
Also in the command class I use a HashMap now which uses the sensor name as a key. <br/>
This way we can avoid the 2 loops and just use one. </p>

<p>Please have a look.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 18, 2012 20:45
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988745"></a>
                                    <font class="smallfont"><p>Well done! It's wonderful <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>That way, with just one shot and one Java thread, I got status of all analogs and digitals I/O on the board.<br/>
Next time I'll come back with the big picture.</p>

<p>Thank you and have a nice day.</p>

<p>&#8212;<br/>
Max</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 19, 2012 10:24
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988746"></a>
                                    <font class="smallfont"><p>Great, once you have a bug picture please share it (Todo, Video, Blogentry,..).</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 19, 2012 10:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988779"></a>
                                    <font class="smallfont"><p>UPDATE:<br/>
everything works as expected except for sliders.</p>

<p>first: in order to make things to work it was necessary to add the following line in the ShellExeCommandBuilder.java file that in your workspace it's missing:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">import</span> org.openremote.controller.utils.CommandUtil;
</pre>
</div></div>
<p>then, and in order to use the ${params} var replacement, required to pass the slider value to the command argument, I have to change this line from:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
commandParams = elementValue;
</pre>
</div></div>
<p>to</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
commandParams = CommandUtil.parseStringWithParam(element, elementValue);
</pre>
</div></div>

<p>second: after that I compile your Controller_2_0_0_Fixes (yes, the building job now goes straightaway without error) and star Open Remote with the "run" arg. Looking at the console debug I can see all polling request and all command issued time by time from the web panel. All I/O, Switch and Sensors are working fine. Then, I set the slider on a new position so it in the first time sets its value and the controller does the rest. But in the second time, when I change it to a new position it does not work, the console debug shows to me that the triggering command is ok but the value remains on the previous one and is not changed.</p>

<p>What was wrong? Do I have to add/change some other codes?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 21, 2012 18:38
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988795"></a>
                                    <font class="smallfont"><p>The problem seems to face with the cache command that does not get update after the building phase.</p>

<p>Debug session.</p>

<p>First time: Start Open Remote Controller and set the slider from 0 to a new position/value:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Building ShellExe command
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: ShellExe Command: commandParams = 1a1=38
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: ShellExe Command: commandPath= k8055m
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: ShellExe Command created successfully
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Will start shell command: k8055m and use params: 1a1=38
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Shell command: k8055m returned:
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Will start shell command: k8055status and use params: <span class="code-keyword">null</span>
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Shell command: k8055status returned: 0 0 off off off off off 38 0 off off off off off off off off
INFO [HTTP-<span class="code-object">Thread</span>-2]: Had waited the skipped sensor ids of statuses in DEVICEID:124551319764815264010042052596470276    sensorID:[236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252]statusChangedSensorID:[243]
INFO [HTTP-<span class="code-object">Thread</span>-2]: Querying changed data from StatusCache...
INFO [HTTP-<span class="code-object">Thread</span>-1]: Had waited the skipped sensor ids of statuses in DEVICEID:597958640087469837065881240532742630    sensorID:[236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252]statusChangedSensorID:[243]
INFO [HTTP-<span class="code-object">Thread</span>-1]: Querying changed data from StatusCache...
INFO [HTTP-<span class="code-object">Thread</span>-1]: Have queried changed data from StatusCache.
INFO [HTTP-<span class="code-object">Thread</span>-2]: Have queried changed data from StatusCache.
INFO [HTTP-<span class="code-object">Thread</span>-2]: Return the polling status.
INFO [HTTP-<span class="code-object">Thread</span>-2]: Finished polling at 2012-05-22 07:10:16
INFO [HTTP-<span class="code-object">Thread</span>-1]: Return the polling status.
INFO [HTTP-<span class="code-object">Thread</span>-1]: Finished polling at 2012-05-22 07:10:16
INFO [HTTP-<span class="code-object">Thread</span>-2]: Querying changed state from ChangedStatus table...
INFO [HTTP-<span class="code-object">Thread</span>-2]: Found: [device =&gt; 124551319764815264010042052596470276, sensorIDs =&gt; 236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252] in ChangedStatus table.
INFO [HTTP-<span class="code-object">Thread</span>-2]: DEVICEID:124551319764815264010042052596470276     sensorID:[236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252]statusChangedSensorID:[]Waiting...
</pre>
</div></div>

<p>Second time: set the slider to a new position/value, chached command does not change:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Found cached ShellExe command with id: 233
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Will start shell command: k8055m and use params: 1a1=38
DEBUG [HTTP-<span class="code-object">Thread</span>-4]: Shell command: k8055m returned:
</pre>
</div></div>

<p>Third time: I change the analog value from the shell with a command line, sensors trigging the changes and the slider get new value right:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
INFO [HTTP-<span class="code-object">Thread</span>-2]: Had waited the skipped sensor ids of statuses in DEVICEID:124551319764815264010042052596470276    sensorID:[236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252]statusChangedSensorID:[243]
INFO [HTTP-<span class="code-object">Thread</span>-2]: Querying changed data from StatusCache...
INFO [HTTP-<span class="code-object">Thread</span>-2]: Have queried changed data from StatusCache.
INFO [HTTP-<span class="code-object">Thread</span>-2]: Return the polling status.
INFO [HTTP-<span class="code-object">Thread</span>-2]: Finished polling at 2012-05-22 07:10:32
INFO [HTTP-<span class="code-object">Thread</span>-2]: Querying changed state from ChangedStatus table...
INFO [HTTP-<span class="code-object">Thread</span>-2]: Found: [device =&gt; 124551319764815264010042052596470276, sensorIDs =&gt; 236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252] in ChangedStatus table.
INFO [HTTP-<span class="code-object">Thread</span>-2]: DEVICEID:124551319764815264010042052596470276     sensorID:[236, 237, 238, 239, 240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252]statusChangedSensorID:[]Waiting...
</pre>
</div></div>

<p>Hereafter round is as above.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 22, 2012 06:22
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988800"></a>
                                    <font class="smallfont"><p>The send() method which is executed when you push a button or set a slider value does not automatically update the sensor.<br/>
The sensors are updated periodically depending on the pollingInterval given.<br/>
It could be that you move the slider and then it takes XX seconds (depending on your polling interval on the command that returns the status) until the sensor knows about it.<br/>
Maybe this could be the problem? If that is the case and you set the pollingInterval = 1s you should be able to use the slider at least every 1 second.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 22, 2012 08:33
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988804"></a>
                                    <font class="smallfont"><p>yes, what you said is ok and the pollingInterval is already set to 1s.</p>

<p>In the previous logs I had excluded the polling lines that are </p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
...
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Will start shell command: k8055status and use params: <span class="code-keyword">null</span>
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Shell command: k8055status returned: 0 0 off off off off off 99 163 on off on off off off off off
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Will start shell command: k8055status and use params: <span class="code-keyword">null</span>
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Shell command: k8055status returned: 0 0 off off off off off 99 163 on off on off off off off off
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Will start shell command: k8055status and use params: <span class="code-keyword">null</span>
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Shell command: k8055status returned: 0 0 off off off off off 99 163 on off on off off off off off
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Will start shell command: k8055status and use params: <span class="code-keyword">null</span>
DEBUG [Polling thread <span class="code-keyword">for</span> sensor: ID1 Sensor 239]: Shell command: k8055status returned: 0 0 off off off off off 99 163 on off on off off off off off
...
</pre>
</div></div>

<p>Even, I have tried with the cache disabled to see how it impact on the slieder command, and yes the slider command works ok. Obviously, by disabling the cache the polling fail.</p>

<p>So the conclusion would be that the slider command should be excluded by the caching process. But I still do not figure out the way to do this.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 22, 2012 09:20
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988805"></a>
                                    <font class="smallfont"><p>I integrated this into the code. <br/>
Thanks for pointing it out.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 22, 2012 09:21
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988806"></a>
                                    <font class="smallfont"><p>Ok, because the slider is always the same command and not like on/off each state has one command the new command cache I introduced make the slider value not change <img class="emoticon" src="images/icons/emoticons/sad.gif" height="20" width="20" align="absmiddle" alt="" border="0"/><br/>
Gotcha!</p>

<p>We realy only want to use the cached command for the status.<br/>
Let me think of something.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 22, 2012 09:31
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988807"></a>
                                    <font class="smallfont"><p>I commited a fix. You can either build yourself or download my version from link above.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at May 22, 2012 09:39
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-19988810"></a>
                                    <font class="smallfont"><p>ok, it works now.</p>

<p>Thank you.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by demo at May 22, 2012 10:31
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21860207"></a>
                                    <font class="smallfont"><p>I tried the shell execution protocol with multiple sensors to save performance on raspberry.</p>

<p>But in the dev.log I can see the shell script is called for every sensor linked to the command, not only once for the status command.</p>

<p>Is this correct?</p>

<p>I tried with OpenRemote-Controller-2.1.0_Alpha-SNAPSHOT-2013-04-09.zip</p>

<p>Bye<br/>
Daniel</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by emster at Apr 13, 2013 09:11
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21860268"></a>
                                    <font class="smallfont"><p>How does your controller.xml look?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Apr 14, 2013 20:15
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21860280"></a>
                                    <font class="smallfont"><p>Hmmm.... after recreating this config and looking deeper what it does, I have to say it works like expected:<br/>
only one call per status command, not for every sensor <img class="emoticon" src="images/icons/emoticons/wink.gif" height="20" width="20" align="absmiddle" alt="" border="0"/> Sorry...</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by emster at Apr 14, 2013 21:30
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 10:46</font></td>
		    </tr>
	    </table>
    </body>
</html>