<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Zwave trouble, Something locked</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Zwave trouble, Something locked
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Nov 07, 2013 by <font color="#0050B2">melchoir55</font>.
				    </div>

				    <p>When I start up my controller, I get the following:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
DEBUG 2013-11-06 16:43:27,939 (Z-Wave): Message lock exists. Frame waiting: 01 09 00 13 07 02 20 02 05 0b cc 
DEBUG 2013-11-06 16:43:27,939 (Z-Wave): Message lock exists. Frame waiting: 01 09 00 13 07 02 20 02 05 0b cc 
DEBUG 2013-11-06 16:43:27,937 (Z-Wave): Message lock exists. Frame waiting: 01 09 00 13 07 02 20 02 05 0b cc 
DEBUG 2013-11-06 16:43:27,937 (Z-Wave): Message lock exists. Frame waiting: 01 09 00 13 07 02 20 02 05 0b cc
DEBUG 2013-11-06 16:43:28,260 (Z-Wave): Timeout reached. Releasing lock.
DEBUG 2013-11-06 16:43:28,260 (Z-Wave): Message lock exists. Frame waiting: 01 09 00 13 07 02 20 02 05 0b cc 
DEBUG 2013-11-06 16:43:28,260 (Z-Wave): sending: 01 09 00 13 07 02 20 02 05 0b cc 
ERROR 2013-11-06 16:43:28,260 (Z-Wave): could not send data: 01 09 00 13 07 02 20 02 05 0b cc 
java.io.IOException
	at gnu.io.RXTXPort$SerialOutputStream.flush(RXTXPort.java:1231)
	at org.openremote.controller.protocol.zwave.ZWaveGatewayRxtx$ZWaveWriterThread.run(ZWaveGatewayRxtx.java:229) 

</pre>
</div></div>

<p>When I try to send a command, I get something like the following:</p>


<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
java.io.IOException
	at gnu.io.RXTXPort$SerialOutputStream.flush(RXTXPort.java:1231)
	at org.openremote.controller.protocol.zwave.ZWaveGatewayRxtx$ZWaveWriterThread.run(ZWaveGatewayRxtx.java:229)
DEBUG 2013-11-06 16:44:45,808 (Z-Wave): received: 01 04 01 13 01 e8 
DEBUG 2013-11-06 16:44:45,808 (Z-Wave): sending: 06 
ERROR 2013-11-06 16:44:45,808 (Z-Wave): could not send data: 06 
java.io.IOException
	at gnu.io.RXTXPort$SerialOutputStream.flush(RXTXPort.java:1231)
	at org.openremote.controller.protocol.zwave.ZWaveGatewayRxtx$ZWaveWriterThread.run(ZWaveGatewayRxtx.java:229)
DEBUG 2013-11-06 16:44:46,188 (Z-Wave): Building Z-Wave command
DEBUG 2013-11-06 16:44:46,188 (Z-Wave): Z-Wave command: nodeId = 6
DEBUG 2013-11-06 16:44:46,189 (Z-Wave): Z-Wave command: command = dim
DEBUG 2013-11-06 16:44:46,189 (Z-Wave): Z-Wave command: paramValue = 89
DEBUG 2013-11-06 16:44:46,189 (Z-Wave): Z-Wave command created successfully
DEBUG 2013-11-06 16:44:46,190 (Z-Wave): Message lock exists. Frame waiting: 01 0a 00 13 06 03 20 01 59 05 18 86 
DEBUG 2013-11-06 16:44:46,240 (Z-Wave): Timeout reached. Releasing lock.
DEBUG 2013-11-06 16:44:46,240 (Z-Wave): sending: 01 0a 00 13 06 03 20 01 59 05 18 86 
ERROR 2013-11-06 16:44:46,240 (Z-Wave): could not send data: 01 0a 00 13 06 03 20 01 59 05 18 86 
java.io.IOException
	at gnu.io.RXTXPort$SerialOutputStream.flush(RXTXPort.java:1231)
	at org.openremote.controller.protocol.zwave.ZWaveGatewayRxtx$ZWaveWriterThread.run(ZWaveGatewayRxtx.java:229)
</pre>
</div></div>

<p>This started happening when I paired a Leviton dimmer to my zstick and added my first drool in designer. I'm not sure which of those two events were the culprit as I did them simultaneously, or if they were the culprit at all. I have tried restarting the controller, resynching, removing the zstick and replacing it, as well as removing my drool from designer. None of these actions had an effect.</p>

<p>My problem is reminiscent of the problem posted here:<a href="http://www.openremote.org/display/forums/Occasional+Z-Wave+problem">http://www.openremote.org/display/forums/Occasional+Z-Wave+problem</a><br/>
The differences are that I am not running on a raspberry. I am running on a powerful windows box. I also do not run zwave.me. </p>

<p>This problem is really frustrating me. I would appreciate any guidance!</p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-22879540"></a>
                                    <font class="smallfont"><p>Make sure you update the controller after deleting rules from designer. This is typical deadlock problem. If you can share your rules, I can make further suggestions.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by atamariya at Nov 07, 2013 03:24
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22879542"></a>
                                    <font class="smallfont"><p>I tried deleting the rule, hitting submit, then hitting save, then syncing to controller. I still got the same scroll of locks.</p>

<p>The rule I deleted looked like:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;

rule <span class="code-quote">"Turn light off"</span> 
when

 Event( value == <span class="code-quote">"on"</span> )

then
  execute.command( <span class="code-quote">"Device 6-Off"</span> );
  execute.command( <span class="code-quote">"Device 7-Off"</span> );
  execute.command( <span class="code-quote">"Device 8-Off"</span> );

end
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by melchoir55 at Nov 07, 2013 05:40
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22879551"></a>
                                    <font class="smallfont"><p>The Event clause should have a <b>source</b> (=sensor). Something like:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">Event( source == <span class="code-quote">"WindGust"</span>, value &gt; 38 )</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Nov 07, 2013 07:51
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22879552"></a>
                                    <font class="smallfont"><p>Constraints shouldn't require specific getters in drools. At least, not to be syntactically correct. It should be possible to just refer to value, or even no class field at all by just referring to "Event()". Nonetheless I tried adding a source. I added a device I have named Bedroom_Dimmer (corresponding to "Device 6"). The same error continues to be thrown.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;

rule <span class="code-quote">"Turn light off"</span> 
when

 Event( source == <span class="code-quote">"Bedroom_Dimmer"</span>,value == <span class="code-quote">"on"</span> )

then
  execute.command( <span class="code-quote">"Device 6-Off"</span> );
  execute.command( <span class="code-quote">"Device 7-Off"</span> );
  execute.command( <span class="code-quote">"Device 8-Off"</span> );

end
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by melchoir55 at Nov 07, 2013 08:09
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22879554"></a>
                                    <font class="smallfont"><p>I don't think your error has something to do with the rule, but rather with the native openremote ZWave protocol. I remember having had these endless <em>Message lock</em> errors on my Synology installation. That was quite a while ago, so I don't recall how/if it was solved as I am not using the native protocol anymore.<br/>
<b>edit</b>: Another page suggested a similar error was caused because the poster used Java 7 instead of 6. </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Nov 07, 2013 08:24
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22879576"></a>
                                    <font class="smallfont"><p>I actually had the same problems with the message locks in the native zwave implementation. I found a way to get rid of those locks by adding a delay between subsequent zwave command messages in drools:</p>

<p> execute.command("Dimmer3_dim",50);<br/>
 TimeUnit.MILLISECONDS.sleep(200);<br/>
 execute.command("Dimmer5_dim",50);</p>

<p>You could give it a try.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aschwith at Nov 07, 2013 17:03
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:43</font></td>
		    </tr>
	    </table>
    </body>
</html>