<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Sending Telnet or TCP IP commands</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Sending Telnet or TCP IP commands
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jun 07, 2010 by <font color="#0050B2">pjmm</font>.
				    </div>

				    <p>I am trying to send commands to a program running on a PC using either Telnet or TCP/IP interface in open remote</p>

<p>I can only get openremote to send one command and it locks up. If I restart openremote or the program I can sucesfully</p>

<p>send one mor command and it locks up again.</p>

<p>I have tested the program on the PC using Putty and it does not lock up but works as it should.</p>

<p>Should I be sending an additional command to reset the interface </p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-10551301"></a>
                                    <font class="smallfont"><p>If I look in the controller log I see</p>

<p>2010-06-07 19:59:22,333 ERROR [HTTP-Thread-2] org.openremote.controller.protocol.socket.TCPSocketEvent.exec(143) &#124; Socket event could not execute<br/>
java.net.ConnectException: Connection refused: connect</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pjmm at Jun 07, 2010 20:30
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551311"></a>
                                    <font class="smallfont"><p>While we shouldn't lock up on that error (bug on our side), that error means that whatever IP device you were trying to connect to cannot be reached (connection refused). Which is a bit strange if you can reach the device from the same IP using Putty.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at Jun 09, 2010 05:35
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551315"></a>
                                    <font class="smallfont"><p>Many thanks for the feedback.</p>

<p>I can comunicate with the device and send one command sucessfully from Openremote.</p>

<p>It then locks up and Openremote must be re started.</p>

<p>With Putty the system does not lock up.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pjmm at Jun 09, 2010 21:35
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551322"></a>
                                    <font class="smallfont"><p>Hello Pierce,</p>

<p>Do you have the full stack trace in the logs you could send? It would be after the ERROR entry with multiple lines of mostly illegible text.</p>

<p>I can take a look at what part of the code the error happened then and see if I notice it has anything to do with error handling.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at Jun 10, 2010 15:45
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551326"></a>
                                    <font class="smallfont"><p>Hi Juha</p>

<p>many thanks for the help. I was looking at what Putty sends at the end of a command and I believe it sends LF</p>

<p>OpenRemote sends CRLF might this have somthing to do with it.</p>

<p>This is the full error report</p>

<p>2010-06-10 17:46:09,044 INFO [Thread-4] org.openremote.controller.net.IPAutoDiscoveryServer.run(60) &#124; Created IP discover multicast server &#33;<br/>
2010-06-10 17:46:09,044 INFO [Thread-4] org.openremote.controller.net.IPAutoDiscoveryServer.run(66) &#124; Joined a group : 224.0.1.100:3333<br/>
2010-06-10 17:46:09,044 INFO [Thread-4] org.openremote.controller.net.IPAutoDiscoveryServer.run(74) &#124; Listening on&nbsp; 224.0.1.100:3333<br/>
2010-06-10 17:46:44,794 ERROR [HTTP-Thread-3] org.openremote.controller.protocol.socket.TCPSocketEvent.exec(143) &#124; Socket event could not execute<br/>
java.net.ConnectException: Connection refused: connect<br/>
&nbsp;&nbsp;&nbsp; at java.net.PlainSocketImpl.socketConnect(Native Method)<br/>
&nbsp;&nbsp;&nbsp; at java.net.PlainSocketImpl.doConnect(PlainSocketImpl.java:333)<br/>
&nbsp;&nbsp;&nbsp; at java.net.PlainSocketImpl.connectToAddress(PlainSocketImpl.java:195)<br/>
&nbsp;&nbsp;&nbsp; at java.net.PlainSocketImpl.connect(PlainSocketImpl.java:182)<br/>
&nbsp;&nbsp;&nbsp; at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:366)<br/>
&nbsp;&nbsp;&nbsp; at java.net.Socket.connect(Socket.java:529)<br/>
&nbsp;&nbsp;&nbsp; at java.net.Socket.connect(Socket.java:478)<br/>
&nbsp;&nbsp;&nbsp; at java.net.Socket.&lt;init&gt;(Socket.java:375)<br/>
&nbsp;&nbsp;&nbsp; at java.net.Socket.&lt;init&gt;(Socket.java:189)<br/>
&nbsp;&nbsp;&nbsp; at org.openremote.controller.protocol.socket.TCPSocketEvent.exec(TCPSocketEvent.java:131)<br/>
&nbsp;&nbsp;&nbsp; at org.openremote.controller.service.impl.ButtonCommandServiceImpl.trigger(ButtonCommandServiceImpl.java:67)<br/>
&nbsp;&nbsp;&nbsp; at org.openremote.controller.rest.ButtonCommandRESTServlet.doPost(ButtonCommandRESTServlet.java:84)<br/>
&nbsp;&nbsp;&nbsp; at javax.servlet.http.HttpServlet.service(HttpServlet.java:637)<br/>
&nbsp;&nbsp;&nbsp; at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:290)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)<br/>
&nbsp;&nbsp;&nbsp; at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:78)<br/>
&nbsp;&nbsp;&nbsp; at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:77)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:235)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:206)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:233)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:191)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:128)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:102)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:109)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:286)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:845)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.coyote.http11.Http11Protocol$Http11ConnectionHandler.process(Http11Protocol.java:583)<br/>
&nbsp;&nbsp;&nbsp; at org.apache.tomcat.util.net.JIoEndpoint$SocketProcessor.run(JIoEndpoint.java:354)<br/>
&nbsp;&nbsp;&nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)<br/>
&nbsp;&nbsp;&nbsp; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)<br/>
&nbsp;&nbsp;&nbsp; at java.lang.Thread.run(Thread.java:619)</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pjmm at Jun 10, 2010 17:55
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551328"></a>
                                    <font class="smallfont"><p>How does the configuration in controller.xml look?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jun 10, 2010 22:02
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551329"></a>
                                    <font class="smallfont"><p>Hi Marcus,</p>

<p>The command I am testing on is tcpSocketEvent. It works once with no errors. When you try again it locks up</p>

<p>controller.xml</p>

<p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br/>
&lt;openremote xmlns="http://www.openremote.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openremote.org <a href="http://www.openremote.org/schemas/controller-1.0-M3.xsd">http://www.openremote.org/schemas/controller-1.0-M3.xsd</a>"&gt;<br/>
&nbsp; &lt;buttons&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="3"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;1&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="6"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;5&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="7"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;4&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="10"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;9&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="11"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;8&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="13"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;12&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;button id="15"&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;event&gt;14&lt;/event&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/button&gt;<br/>
&nbsp; &lt;/buttons&gt;<br/>
&nbsp; &lt;events&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;irEvents&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/irEvents&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;knxEvents&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/knxEvents&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;x10Events&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/x10Events&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;httpEvents&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/httpEvents&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;socketEvents&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;tcpSocketEvent id="14" label="greenbutton" ip="192.168.1.7" port="4998" command="gggggggggggg"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/socketEvents&gt;<br/>
&nbsp;&nbsp;&nbsp; &lt;telnetEvents&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;telnetEvent id="9" label="ch-" ip="192.168.1.7" port="4998" command="ASCI notepad"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;telnetEvent id="8" label="ch+" ip="192.168.1.7" port="4998" command="+"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;telnetEvent id="5" label="Vol &#45;" ip="192.168.1.7" port="4998" command="vol-"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;telnetEvent id="4" label="Vol &#43;" ip="192.168.1.7" port="4998" command="vol+"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;telnetEvent id="1" label="GreenButton" ip="192.168.1.7" port="4998" command="greenbutton"/&gt;</p>

<p>&nbsp;&nbsp;&nbsp; &lt;/telnetEvents&gt;<br/>
&nbsp; &lt;/events&gt;<br/>
&lt;/openremote&gt;</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pjmm at Jun 10, 2010 22:10
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551334"></a>
                                    <font class="smallfont"><p>Thanks,</p>

<p>nothing in particular stands out in that part of the code, the error handling looks correct on a visual (don't have reproducible test cases at the moment) so it shouldn't be the part locking up:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
   <span class="code-keyword">public</span> void exec() {
-	   Socket socket = <span class="code-keyword">null</span>;
-		<span class="code-keyword">try</span> {
-			socket = <span class="code-keyword">new</span> Socket(getIp(), <span class="code-object">Integer</span>.parseInt(getPort()));
-			OutputStream out = socket.getOutputStream();
-
-			StringTokenizer st = <span class="code-keyword">new</span> StringTokenizer(getCommand(), <span class="code-quote">"|"</span>);
-			<span class="code-keyword">while</span> (st.hasMoreElements()) {
-				<span class="code-object">String</span> cmd = (<span class="code-object">String</span>) st.nextElement();
-				out.write((cmd+<span class="code-quote">"\r"</span>).getBytes());
-			}
-
-			<span class="code-object">String</span> result = readReply(socket);
-			logger.info(<span class="code-quote">"received message: "</span> + result);
-		} <span class="code-keyword">catch</span> (Exception e) {
-			logger.error(<span class="code-quote">"Socket event could not execute"</span>, e);
-		} <span class="code-keyword">finally</span> {
-			<span class="code-keyword">if</span> (socket != <span class="code-keyword">null</span>)  {
-				<span class="code-keyword">try</span> {
-					socket.close();
-				} <span class="code-keyword">catch</span> (IOException e) {
-					logger.error(<span class="code-quote">"Socket could not be closed"</span>, e);
-				}
-			}
-		}
-   }
</pre>
</div></div>

<p>On the output (line "out.write((cmd+"\r").getBytes());") it looks like CR is sent (literal '\r') instead of LF (which would be literal '\n'). I don't know if this would be in any way related to your issue.</p>

<p>That's all I've got so far, let me know if you can find any other details that would help to resolve this for you.</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at Jun 11, 2010 16:54
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-10551335"></a>
                                    <font class="smallfont"><p>I guess a possibility is that whatever service you're using over TCP/IP is expecting LF as a signal to send response, where as we send CF and then sit on the 'readReply()' which never returns, thus looking like a lockup.</p>

<p>Don't know why it would work once then though and only then stop working. Would need to be able to analyze the live system to see where it hangs.</p>

<p>Guess could blindly try '\n' instead of '\r' to see if it makes a difference.</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by juha at Jun 11, 2010 17:02
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 11:01</font></td>
		    </tr>
	    </table>
    </body>
</html>