<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Rules for Pseudo KNX Alarm - Urgent</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Rules for Pseudo KNX Alarm - Urgent
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Nov 30, 2012 by <font color="#0050B2">mikemelga</font>.
				    </div>

				    <p>Please help!<br/>
My house alarm (a cheap GSM alarm) has stopped functioning. The house is finishing construction so I really need an alarm especially during night time.<br/>
I haven't slept the last two nights monitoring my cams. </p>

<p>So... While I don't install the KNX alarm, I thought in using the KNX switches and sensors to act as a pseudo alarm.<br/>
The basic functionality is this:</p>

<p>1-Detects motion<br/>
2-Tells Eventghost<br/>
3-PBX dials my phone</p>

<p>I already made the Eventghost and PBX part.<br/>
In openremote I already have all the switch/sensor/commands (on/off) I will be needing.</p>

<p>My problem are the rules:<br/>
-If I blank the modeler_rules.drl file, the server starts ok with no rules.<br/>
-As soon as I use something in the file the server starts with this error:<br/>
(I had problems before due to java 7. Downgraded to 6 and those errors were gone. OR is on a Windows 7 32Bits)</p>

<p>_________________________________________________________________________________________________________</p>

<p>--------------------------------------------------------------------</p>

<p>  DEPLOYING NEW CONTROLLER RUNTIME...</p>

<p>--------------------------------------------------------------------</p>

<p>ERROR 2012-11-30 11:51:40,329 : Rule definition 'modeler_rules.drl' could not be<br/>
 deployed. See errors below.<br/>
ERROR main: Rule definition 'modeler_rules.drl' could not be deployed. See err<br/>
ors below.<br/>
ERROR 2012-11-30 11:51:40,340 : ERR 103 Line 2:0 rule 'rule_key' failed predic<br/>
ate: <div class="error"><span class="error">Unknown macro: {(validateIdentifierKey(DroolsSoftKeywords.RULE))}</span> </div>? in rule<br/>
ERROR main: ERR 103 Line 2:0 rule 'rule_key' failed predicate: <div class="error"><span class="error">Unknown macro: {(validateIde
ntifierKey(DroolsSoftKeywords.RULE))}</span> </div>? in rule<br/>
ERROR 2012-11-30 11:51:40,349 : ERR 101 Line 2:8 no viable alternative at inpu<br/>
t 'org' in rule package<br/>
ERROR main: ERR 101 Line 2:8 no viable alternative at input 'org' in rule pa<br/>
ckage<br/>
ERROR 2012-11-30 11:51:40,359 : ERR 101 Line 3:0 no viable alternative at inpu<br/>
t 'global' in rule package in rule event<br/>
ERROR main: ERR 101 Line 3:0 no viable alternative at input 'global' in rule<br/>
 package in rule event<br/>
2,0: ERR 103 Line 2:0 rule 'rule_key' failed predicate: <div class="error"><span class="error">Unknown macro: {(validateIdentifier
Key(DroolsSoftKeywords.RULE))}</span> </div>? in rule<br/>
2,8: ERR 101 Line 2:8 no viable alternative at input 'org' in rule package<br/>
3,0: ERR 101 Line 3:0 no viable alternative at input 'global' in rule packag<br/>
e in rule event<br/>
ERROR 2012-11-30 11:51:40,393 : There was an error parsing the rule definition '<br/>
modeler_rules.drl' : Could not parse knowledge.<br/>
java.lang.IllegalArgumentException: Could not parse knowledge.<br/>
        at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(Knowled<br/>
geBuilderImpl.java:58)<br/>
        at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowle<br/>
dgePackages(RuleEngine.java:532)<br/>
        at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngi<br/>
ne.java:253)<br/>
        at org.openremote.controller.statuscache.EventProcessorChain.start(Event<br/>
ProcessorChain.java:112)<br/>
        at org.openremote.controller.statuscache.StatusCache.start(StatusCache.j<br/>
ava:120)<br/>
        at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorM<br/>
odel(Version20ModelBuilder.java:615)<br/>
        at org.openremote.controller.deployer.Version20ModelBuilder.build(Versio<br/>
n20ModelBuilder.java:537)<br/>
        at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(Ab<br/>
stractModelBuilder.java:148)<br/>
        at org.openremote.controller.service.Deployer.startup(Deployer.java:760)</p>

<p>        at org.openremote.controller.service.Deployer.startController(Deployer.j<br/>
ava:271)<br/>
        at org.openremote.controller.spring.SpringContext.initializeController(S<br/>
pringContext.java:109)<br/>
        at org.openremote.controller.service.ServiceContext.init(ServiceContext.<br/>
java:364)<br/>
        at org.openremote.controller.bootstrap.Startup.loadServiceContext(Startu<br/>
p.java:85)<br/>
        at org.openremote.controller.bootstrap.servlet.ServletStartup.initialize<br/>
ServiceContext(ServletStartup.java:190)<br/>
        at org.openremote.controller.bootstrap.servlet.ServletStartup.contextIni<br/>
tialized(ServletStartup.java:109)<br/>
        at org.apache.catalina.core.StandardContext.listenerStart(StandardContex<br/>
t.java:3843)<br/>
        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4<br/>
342)<br/>
        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase<br/>
.java:791)<br/>
        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:77<br/>
1)<br/>
        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)</p>

<p>        at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.jav<br/>
a:926)<br/>
        at org.apache.catalina.startup.HostConfig.deployDirectories(HostConfig.j<br/>
ava:889)<br/>
        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492<br/>
)<br/>
        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1149)<br/>
        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java<br/>
:311)<br/>
        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(Lifecycl<br/>
eSupport.java:117)<br/>
        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053)</p>

<p>        at org.apache.catalina.core.StandardHost.start(StandardHost.java:719)<br/>
        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1045)</p>

<p>        at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:443<br/>
)<br/>
        at org.apache.catalina.core.StandardService.start(StandardService.java:5<br/>
16)<br/>
        at org.apache.catalina.core.StandardServer.start(StandardServer.java:710<br/>
)<br/>
        at org.apache.catalina.startup.Catalina.start(Catalina.java:578)<br/>
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.<br/>
java:39)<br/>
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAcces<br/>
sorImpl.java:25)<br/>
        at java.lang.reflect.Method.invoke(Method.java:597)<br/>
        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:288)<br/>
        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)<br/>
ERROR main: There was an error parsing the rule definition 'modeler_rules.drl'<br/>
 : Could not parse knowledge.<br/>
java.lang.IllegalArgumentException: Could not parse knowledge.<br/>
        at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(Knowled<br/>
geBuilderImpl.java:58)<br/>
        at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowle<br/>
dgePackages(RuleEngine.java:532)<br/>
        at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngi<br/>
ne.java:253)<br/>
        at org.openremote.controller.statuscache.EventProcessorChain.start(Event<br/>
ProcessorChain.java:112)<br/>
        at org.openremote.controller.statuscache.StatusCache.start(StatusCache.j<br/>
ava:120)<br/>
        at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorM<br/>
odel(Version20ModelBuilder.java:615)<br/>
        at org.openremote.controller.deployer.Version20ModelBuilder.build(Versio<br/>
n20ModelBuilder.java:537)<br/>
        at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(Ab<br/>
stractModelBuilder.java:148)<br/>
        at org.openremote.controller.service.Deployer.startup(Deployer.java:760)</p>

<p>        at org.openremote.controller.service.Deployer.startController(Deployer.j<br/>
ava:271)<br/>
        at org.openremote.controller.spring.SpringContext.initializeController(S<br/>
pringContext.java:109)<br/>
        at org.openremote.controller.service.ServiceContext.init(ServiceContext.<br/>
java:364)<br/>
        at org.openremote.controller.bootstrap.Startup.loadServiceContext(Startu<br/>
p.java:85)<br/>
        at org.openremote.controller.bootstrap.servlet.ServletStartup.initialize<br/>
ServiceContext(ServletStartup.java:190)<br/>
        at org.openremote.controller.bootstrap.servlet.ServletStartup.contextIni<br/>
tialized(ServletStartup.java:109)<br/>
        at org.apache.catalina.core.StandardContext.listenerStart(StandardContex<br/>
t.java:3843)<br/>
        at org.apache.catalina.core.StandardContext.start(StandardContext.java:4<br/>
342)<br/>
        at org.apache.catalina.core.ContainerBase.addChildInternal(ContainerBase<br/>
.java:791)<br/>
        at org.apache.catalina.core.ContainerBase.addChild(ContainerBase.java:77<br/>
1)<br/>
        at org.apache.catalina.core.StandardHost.addChild(StandardHost.java:525)</p>

<p>        at org.apache.catalina.startup.HostConfig.deployDirectory(HostConfig.jav<br/>
a:926)<br/>
        at org.apache.catalina.startup.HostConfig.deployDirectories(HostConfig.j<br/>
ava:889)<br/>
        at org.apache.catalina.startup.HostConfig.deployApps(HostConfig.java:492<br/>
)<br/>
        at org.apache.catalina.startup.HostConfig.start(HostConfig.java:1149)<br/>
        at org.apache.catalina.startup.HostConfig.lifecycleEvent(HostConfig.java<br/>
:311)<br/>
        at org.apache.catalina.util.LifecycleSupport.fireLifecycleEvent(Lifecycl<br/>
eSupport.java:117)<br/>
        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1053)</p>

<p>        at org.apache.catalina.core.StandardHost.start(StandardHost.java:719)<br/>
        at org.apache.catalina.core.ContainerBase.start(ContainerBase.java:1045)</p>

<p>        at org.apache.catalina.core.StandardEngine.start(StandardEngine.java:443<br/>
)<br/>
        at org.apache.catalina.core.StandardService.start(StandardService.java:5<br/>
16)<br/>
        at org.apache.catalina.core.StandardServer.start(StandardServer.java:710<br/>
)<br/>
        at org.apache.catalina.startup.Catalina.start(Catalina.java:578)<br/>
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br/>
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.<br/>
java:39)<br/>
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAcces<br/>
sorImpl.java:25)<br/>
        at java.lang.reflect.Method.invoke(Method.java:597)<br/>
        at org.apache.catalina.startup.Bootstrap.start(Bootstrap.java:288)<br/>
        at org.apache.catalina.startup.Bootstrap.main(Bootstrap.java:413)</p>

<p>.....</p>

<p>INFO: Server startup in 9499 ms</p>

<p>____________________________________________________________________________________________________________________</p>


<p>The rules script I am using is this:</p>



<p>package org.openremote.controller.model.event<br/>
global org.openremote.controller.statuscache.CommandFacade execute;<br/>
global org.openremote.controller.statuscache.SwitchFacade switches;<br/>
import org.openremote.controller.protocol.*;</p>

<p>rule "Send Alarm"</p>

<p>when<br/>
    Switch(source == "Switch1", value == "ON")<br/>
then<br/>
    execute.command("Script1"); <br/>
end</p>



<p>Which is based on an example I've seen in this forum.<br/>
About this script I have some questions:</p>

<p>1 - The 'Switch1' name should be the sensor name or the switch name?<br/>
2 - The 'Script1' is a shell execution command. I do not need additional parameters, right?</p>


<p>Any help is more than welcome.<br/>
I need to sleep!  <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Thanks!</p>

				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-21037965"></a>
                                    <font class="smallfont"><p>1 - Sensor<br/>
2 - rught</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Dec 01, 2012 09:08
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21037976"></a>
                                    <font class="smallfont"><p>Marcus,</p>

<p>Thank you!</p>

<p>Do you have any opinion on the rules not starting?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mikemelga at Dec 01, 2012 18:31
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21037983"></a>
                                    <font class="smallfont"><p>Can you post your rule definition? <br/>
Put the data between 2 {code} elements.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Dec 01, 2012 21:07
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038005"></a>
                                    <font class="smallfont"><p>Marcus,</p>

<p>Thanks for the help:</p>

<p>My current rules file contains this:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.model.event

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;

<span class="code-keyword">import</span> org.openremote.controller.protocol.Event;

rule <span class="code-quote">"Turn Music on via KNX"</span>
when
  $evt:Event(source == <span class="code-quote">"Sn Hall Entrada"</span>, value == <span class="code-quote">"on"</span>)
then
  execute.command(<span class="code-quote">"Alarme"</span>);
end
</pre>
</div></div>

<p>but I tried other rules like this one:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.model.event

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;

<span class="code-keyword">import</span> org.openremote.controller.protocol.Event;

rule <span class="code-quote">"Alarm Test"</span>
 
when
    Switch(source == <span class="code-quote">"Sn Hall Entrada"</span>, value == <span class="code-quote">"on"</span>)
then
    execute.command(<span class="code-quote">"Alarme"</span>); 
end
</pre>
</div></div>

<p>giving me the same error/result</p>


<p>Any suggestion?</p>

<p>Thanks</p>
</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mikemelga at Dec 02, 2012 15:44
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038008"></a>
                                    <font class="smallfont"><p>Looks ok. But the error in your first post is hard to catch.<br/>
Can you attach the logfile to this thread. Then it's easier.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Dec 02, 2012 17:09
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038009"></a>
                                    <font class="smallfont"><p>Marcus,</p>

<p>What logfiles do you want?</p>

<p>I have tons of logs in the logs dir <img class="emoticon" src="images/icons/emoticons/sad.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Thanks.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mikemelga at Dec 02, 2012 17:52
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038010"></a>
                                    <font class="smallfont"><p>Probably catalina.out and dev/dev.log.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Dec 02, 2012 18:59
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038044"></a>
                                    <font class="smallfont"><p>Marcus,</p>

<p>I didn't find a catalina.out file.<br/>
Anyway I've cleaned my logs and started the server. I zipped the relevant logs in this zip file:</p>

<p><a href="https://www.dropbox.com/s/seyd39ktqb99b31/openremote_logs.zip?m">https://www.dropbox.com/s/seyd39ktqb99b31/openremote_logs.zip?m</a></p>

<p>If you can spare a minute to see what is wrong I would be appreciated.</p>

<p>Thanks again for your time.</p>

<p>Regards,<br/>
mike</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mikemelga at Dec 03, 2012 12:02
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038045"></a>
                                    <font class="smallfont"><p>The error must be in the rules definition:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
2012-12-03 11:42:31,460 DEBUG [main]: Initializing event processor: Drools Rule Engine
2012-12-03 11:42:31,643 DEBUG [main]: Adding Rule 'modeler_rules.drl'...
2012-12-03 11:42:34,314 ERROR [main]: Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
2012-12-03 11:42:34,321 ERROR [main]: [ERR 103] Line 2:0 rule 'rule_key' failed predicate: {(validateIdentifierKey(DroolsSoftKeywords.RULE))}? in rule
2012-12-03 11:42:34,328 ERROR [main]: [ERR 101] Line 2:8 no viable alternative at input 'org' in rule <span class="code-keyword">package</span>
2012-12-03 11:42:34,337 ERROR [main]: [ERR 101] Line 3:0 no viable alternative at input 'global' in rule <span class="code-keyword">package</span> in rule event
2012-12-03 11:42:34,373 ERROR [main]: There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
</pre>
</div></div>

<p>Since your rule looks ok to me, the only difference I can see is the empty line after "rule....".<br/>
You wrote, that you tried without the empty line, but maybe that was not deployed correct. You have to tab out of the textfield and hit save.<br/>
Also make sure the design is saved, this does not always happen, if only the rule is changed.<br/>
You can always verify or even edit the rule file on the controller: Controller-2-0-1/webapps/controller/rules</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Dec 03, 2012 12:18
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21038047"></a>
                                    <font class="smallfont"><p>Marcus,</p>

<p>Problem solved! I removed the two blank lines on top and below the global... and it started working.</p>

<p>THANKS!</p>

<p>I didn't know that it was so picky. Is there any external rules editor we can use?</p>

<p>I am now having a different error but I will investigate it  <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Thanks again.</p>

<p>Regards,<br/>
mike</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mikemelga at Dec 03, 2012 14:22
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 10:45</font></td>
		    </tr>
	    </table>
    </body>
</html>