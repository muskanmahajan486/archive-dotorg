<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Sunset time</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Sunset time
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Nov 26, 2013 by <font color="#0050B2">bourrin</font>.
				    </div>

				    <p>Hi,</p>

<p>I am a newbe with openremote.</p>

<p>I use a Synology with AEON Stick to drive roller shutters.</p>

<p>I have build a rule with a timer to open and close, but I would use real sunrise time.</p>

<p>I have found a xml provider who do this : <a href="http://www.earthtools.org/sun/45.758682/5.014803/26/11/99/0">http://www.earthtools.org/sun/45.758682/5.014803/26/11/99/0</a></p>

<p>Can someone tell me how I can improve it in a rule ?</p>

<p>Sorry, for my poor english <img class="emoticon" src="images/icons/emoticons/wink.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>


				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-22880329"></a>
                                    <font class="smallfont"><p>Use the DateTime protocol <a href="http://www.openremote.org/display/docs/OpenRemote+2.0+How+To+-+DateTime+Protocol">http://www.openremote.org/display/docs/OpenRemote+2.0+How+To+-+DateTime+Protocol</a><br/>
Then you can use isDay sensor to drive your roller shutters.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Nov 26, 2013 13:23
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880342"></a>
                                    <font class="smallfont"><p>I have here <a href="http://www.openremote.org/display/docs/OpenRemote+2.0+How+To+-+Control+Sunshades+-+Somfy+with+Raspberry+Pi#OpenRemote2.0HowTo-ControlSunshades-SomfywithRaspberryPi-Automation">Sunscreen docking</a> an example of controlling Sunshades taking into account day/night, rain, wind gusts. A rule for lowering the sunshades on high radiation, high inside temperature, day/night is being tested at the moment.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Nov 26, 2013 14:03
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880344"></a>
                                    <font class="smallfont"><p>If I have understand with this two rules and a sensor created as described in the tuto </p>

<p>rule "Store off at sunset"<br/>
when <br/>
  CustomState( source=="Sensor isDay", value=="false")<br/>
then<br/>
  execute.command("fermeture volet cuisine &#45;OFF&#45;"); <br/>
end</p>

<p>rule "Store on at sunrise"<br/>
when<br/>
  CustomState( source=="Sensor isDay", value=="true")<br/>
then<br/>
  execute.command("ouverture volet cuisine &#45;ON&#45;"); <br/>
end</p>

<p>My roller will open and close when the value of isDay change ?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 14:27
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880345"></a>
                                    <font class="smallfont"><p>When I try to deploy my rules I have this error : ERROR 2013-11-26 15:32:00,097 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.</p>

<div style="max-width:800px;"><div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>ERROR [Controller Definition File Watcher for Default Deployer]: Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2013-11-26 15:32:00,098 : Unable to resolve ObjectType 'CustomState'
ERROR [Controller Definition File Watcher for Default Deployer]: Unable to resolve ObjectType 'CustomState'
ERROR 2013-11-26 15:32:00,098 : Unable to resolve ObjectType 'CustomState'
ERROR [Controller Definition File Watcher for Default Deployer]: Unable to resolve ObjectType 'CustomState'
Unable to resolve ObjectType 'CustomState' : [Rule name='Store off at sunset']

Unable to resolve ObjectType 'CustomState' : [Rule name='Store on at sunrise']

ERROR 2013-11-26 15:32:00,109 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
        at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
        at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
        at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
        at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
        at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
        at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
        at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
        at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
        at org.openremote.controller.service.Deployer.startup(Deployer.java:858)
        at org.openremote.controller.service.Deployer.softRestart(Deployer.java:440)
        at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1324)
        at java.lang.Thread.run(Thread.java:662)
ERROR [Controller Definition File Watcher for Default Deployer]: There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
        at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
        at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
        at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
        at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
        at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
        at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
        at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
        at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
        at org.openremote.controller.service.Deployer.startup(Deployer.java:858)
        at org.openremote.controller.service.Deployer.softRestart(Deployer.java:440)
        at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1324)
        at java.lang.Thread.run(Thread.java:662)
INFO 2013-11-26 15:32:00,123 : Initialized event processor : Drools Rule Engine
INFO 2013-11-26 15:32:00,157 : Initialized event processor : RRD4J Data Logger
INFO 2013-11-26 15:32:00,158 : Initialized event processor : EmonCMS Data Logger
INFO 2013-11-26 15:32:00,197 : Registered sensor : Switch Sensor (Name = 'switch volet cuisine', ID = '39')
INFO 2013-11-26 15:32:00,699 : Registered sensor : Sensor (Name = 'Sensor isDay', ID = '43', State Mappings: {})
INFO 2013-11-26 15:32:00,705 : Startup complete.
</pre>
</div></div></div>

<p>Here are my rules : </p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.model.event

global org.openremote.controller.statuscache.CommandFacade execute;
global org.openremote.controller.statuscache.SwitchFacade switches;
<span class="code-keyword">import</span> org.openremote.controller.protocol.*;

rule <span class="code-quote">"Store off at sunset"</span>
when 
  CustomState( source==<span class="code-quote">"Sensor isDay"</span>, value==<span class="code-quote">"<span class="code-keyword">false</span>"</span>)
then
  execute.command(<span class="code-quote">"fermeture volet cuisine -OFF-"</span>); 
end

rule <span class="code-quote">"Store on at sunrise"</span>
when
  CustomState( source==<span class="code-quote">"Sensor isDay"</span>, value==<span class="code-quote">"<span class="code-keyword">true</span>"</span>)
then
  execute.command(<span class="code-quote">"ouverture volet cuisine -ON-"</span>); 
end
</pre>
</div></div>

<p>Can you help me ?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 14:35
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880346"></a>
                                    <font class="smallfont"><p>I resync one time the controller and I have no more error.</p>

<p>Now I'm waiting for the night to see if it works...</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 14:46
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880347"></a>
                                    <font class="smallfont"><p>Yes, one or two resync's appear to be a good remedy. I run OR on a Synology NAS. Sometimes a restart of the NAS does help. </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Nov 26, 2013 14:57
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880349"></a>
                                    <font class="smallfont"><p>Good news, it works but it is a little too early.</p>

<p>How can do to close 30 minutes after sunset and open 30 minutes before sunrise ?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 16:08
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880350"></a>
                                    <font class="smallfont"><p>Probably you would need the civil sunset time, but it is not available in the current controller version. You can delay sunset by using minutesUntilSunset and execute the command when this number is 1410 (so in fact about 30 minutes after sunset).</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Nov 26, 2013 16:24
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880351"></a>
                                    <font class="smallfont"><p>I have done a rule with a new sensor datetime with the function minutesUntilSunset</p>

<p>CustomState( source=="Sensor Sunset", value=="1385")</p>

<p>But it does not work.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 16:46
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880352"></a>
                                    <font class="smallfont"><p>I have done a rule with a new sensor datetime with the function minutesUntilSunset</p>

<p>CustomState( source=="Sensor Sunset", value=="1385")</p>

<p>But it does not work.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 16:46
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22880354"></a>
                                    <font class="smallfont"><p>In fact, it work, I just forget to save in the designer before synchronise to controller.</p>

<p>I am dummy ...</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by bourrin at Nov 26, 2013 17:42
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22887802"></a>
                                    <font class="smallfont"><p>My friend has a teenage son who is into home automation, and while discussing my OpenRemote setup with him, he came up with a brilliant solution for adjusting sunrise and sunset: simply adjust the longitude setting eastward to move the desired event earlier, and vice versa.  The earth rotates at 15 degrees/hour, so for example, to close your shades 30 minutes later add 7.5 to your longitude entry. </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by russ at Aug 02, 2014 13:51
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22887813"></a>
                                    <font class="smallfont"><p>Yes, this would add absolute time, just like examples above. However, since the real point is rather the position of the sun below horizon (which defines how dark it is), the ultimate solution would be to add different types of sunsets as they are defined already in the library. The only problem is the lack of user interface to call these.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Aug 02, 2014 21:01
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22887840"></a>
                                    <font class="smallfont"><p>I have faced the same problem and I am going to change DateTimeCommand a little bit. In the simple version I will just switch to civil sunset/sunrise. The more flexible way will be to specify type of sunset/sunrise after semicolon. This is the easiest solution to not change the designer. So for example you could specify following commands in DateTimeCommand UI:</p>
<ul class="alternate" type="square">
	<li>"isDay",</li>
	<li>"isDay;CIVIL",</li>
	<li>"isDay;-5" - this is an arbitrary angle (for example CIVIL is -6, OFFICIAL is -0.8333).</li>
</ul>


<p>Actually I did already the simple version, but it is not yet tested. I hope to test this today/tomorrow.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by druciak at Aug 04, 2014 13:57
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22887841"></a>
                                    <font class="smallfont"><p>I don't think this is a good idea. By changing your location you'll "shift" only the moment of sunset and sunrise. So you'll have later sunset, but also later sunrise. We most people need is - for example - later sunset, sooner sunrise. At least this is what I need.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by druciak at Aug 04, 2014 14:00
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22887917"></a>
                                    <font class="smallfont"><p>I created two commands, "isNight" and "isDay" which calculate the respective events shifted in the desired direction via longitude adjustment, then used these to trigger the desired rules.  </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by russ at Aug 08, 2014 16:59
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:39</font></td>
		    </tr>
	    </table>
    </body>
</html>