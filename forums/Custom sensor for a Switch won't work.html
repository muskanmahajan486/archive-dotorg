<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Custom sensor for a Switch won't work</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Custom sensor for a Switch won't work
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jan 16, 2013 by <font color="#0050B2">jsroques</font>.
				    </div>

				    <p>Hello,</p>

<p>I am quite new to OpenRemote (and home automation) and I am trying OpenRemote.</p>

<p>I have an IPX800 which is an ethernet relay board. I created a </p>
<ul class="alternate" type="square">
	<li>new device,</li>
	<li>3 commands : on, off and status for one channel,</li>
	<li>one custom sensor base on status command and set 2 customs states items : Name=GetOut1=1 value=on / Name=Getout1=0 value=off,</li>
	<li>one switch base on the 3 commands</li>
</ul>


<p>In a new pane, I created a switch associated to my switch command.</p>

<p>If switch state is off, I can turn it on, then I can't turn if off, just as if it was seiing an "off" state instead of an "on" state (I also tried to "invert" both on &amp; off commands to check off commads was correct and it is.)</p>

<p>Did I miss something obvious ?</p>

<p>Thanks !<br/>
JS</p>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">Attachments:</a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/21659687.png">cus_sens.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/21659688.png">custom sensor ipx800.PNG</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/21659689.png">IMG_0587.PNG</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/22052873.class">TCPSocketCommand.class</a> (application/octet-stream)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/22052872.class">TCPSocketCommandBuilder.class</a> (application/octet-stream)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/21529339/22052871.class">TCPSocketCommand.class</a> (application/octet-stream)
                                <br/>
                                                    </div>
				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-21529342"></a>
                                    <font class="smallfont"><p>It looks like your sensor is not working.<br/>
Associate the sensor with a label and see if on/off is displayed correct.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 17, 2013 07:57
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529388"></a>
                                    <font class="smallfont"><p>Hello Marcus,</p>

<p>I tried the following : I created a label and selected my sensor. In "Sensor State, I get 2 "Sensor States" which match what is received by the source, that is "GetOut1=1" and "GetOut1=0". I respectively set them to "On" and "On" and that works.</p>

<p>Also, I tried an image, used the very same config and that works.</p>

<p>I am not sure to get how custom switch should be configured though. Should tha states be "on" and "off" ?</p>

<p>In the switch "Custom state Items", I set the "Name" column to the received strings ("GetOut1=1" and "GetOut1=0") and the value to "on" and "off". I tried the other way round, but it does not work at all.</p>

<p>I did have a look ionto dev.log file and got this :</p>

<p>If its "on" :<br/>
13-01-17 19:33:12,991 INFO Polling Sensor Thread ID = 30, Name ='Out1\-Status': received message: GetOut1<br/>
2013-01-17 19:33:12,991 TRACE Polling Sensor Thread ID = 30, Name ='Out1\-Status': Processed GetOut1=0, received GetOut1=0<br/>
=013-01-17 19:33:13,241 INFO Polling Sensor Thread ID = 20, Name ='Out1\-Status': received message: GetOut1<br/>
2013-01-17 19:33:13,242 TRACE Polling Sensor Thread ID = 20, Name ='Out1\-Status': Processed state-2, received state-2</p>

<p>if its "off" :<br/>
113-01-17 19:34:56,101 INFO Polling Sensor Thread ID = 30, Name ='Out1\-Status': received message: GetOut1<br/>
2013-01-17 19:34:56,102 TRACE Polling Sensor Thread ID = 30, Name ='Out1\-Status': Processed GetOut1=1, received GetOut1=1<br/>
=113-01-17 19:34:56,290 INFO Polling Sensor Thread ID = 20, Name ='Out1\-Status': received message: GetOut1<br/>
2013-01-17 19:34:56,290 TRACE Polling Sensor Thread ID = 20, Name ='Out1\-Status': Processed state-1, received state-1</p>

<p>I don't understand </p>
<ul class="alternate" type="square">
	<li>why I have 2 "sets" of lines, one with "state-1" or "state-2", the other with "GetOut1=0" or "GetOut1=1"</li>
	<li>why there is an "=0" or "=1" at the start of the 3rd line.</li>
</ul>


<p>What am I missing ? Or would that be a probelm that the received string contains "=" ?</p>

<p>Thanks !<br/>
JS</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 17, 2013 18:41
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529394"></a>
                                    <font class="smallfont"><p>Quick summary, which is working (I just tested this).<br/>
You need </p>
<ul class="alternate" type="square">
	<li>on command</li>
	<li>off command</li>
	<li>status command</li>
</ul>


<p>Those you already have and status returns either "GetOut1=0" or "GetOut1=1".</p>

<p>For the switch to work correct you also need a sensor which in your case has to be a custom sensor.<br/>
The command for the custom sensor will be your status command and since your command does not return "on" or "off" you need to map those.<br/>
You need to mapping Name=off value=GetOut1=0 and Name=On value=GetOut1=1<br/>
Like this:<br/>
<a class="confluence-thumbnail-link 394x456" href='http://www.openremote.org/download/attachments/21529339/cus_sens.png'><img src="attachments/thumbnails/21529339/21659687" align="absmiddle" border="0"/></a></p>

<p>Then you need to switch object (still building modeler) which is using your on and off command and you custom sensor.<br/>
After that you can use a switch in the UI designer and link to the switch from the building modeler.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 17, 2013 21:01
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529401"></a>
                                    <font class="smallfont"><p>Hello again,</p>

<p>Here is a screenshot of my sensor config now :</p>

<p><a class="confluence-thumbnail-link 369x444" href='http://www.openremote.org/download/attachments/21529339/custom sensor ipx800.PNG'><img src="attachments/thumbnails/21529339/21659688" align="absmiddle" border="0"/></a></p>

<p>It still won't work ! If I create a Label, it would show state-1 or state-2 instead of on or off just like if the mapping did not work :</p>

<p><a class="confluence-thumbnail-link 640x960" href='http://www.openremote.org/download/attachments/21529339/IMG_0587.PNG'><img src="attachments/thumbnails/21529339/21659689" align="absmiddle" border="0"/></a></p>

<p>Thanks for your patience Marcus.<br/>
JS</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 17, 2013 22:47
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529405"></a>
                                    <font class="smallfont"><p>Which version of the controller are you using?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 18, 2013 08:56
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529422"></a>
                                    <font class="smallfont"><p>I am using 2.0.1 on a Synology NAS. I also tried 2.0.1 on my PC.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 18, 2013 12:06
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529424"></a>
                                    <font class="smallfont"><p>Can you try the 2.1-DeveloperSnapshot: <a href="http://sourceforge.net/projects/openremote/files/For%20Developers/OpenRemote%202.0%20%28Developer%20Releases%29/OpenRemote-Controller-2.1.0_Developer-Snapshot-20120920.zip/download">http://sourceforge.net/projects/openremote/files/For%20Developers/OpenRemote%202.0%20%28Developer%20Releases%29/OpenRemote-Controller-2.1.0_Developer-Snapshot-20120920.zip/download</a><br/>
If you unpack this, the folder is still called 2.0.1 but still there are some fixes in there. I am not sure but maybe something in this area was fixed too.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 18, 2013 13:12
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529426"></a>
                                    <font class="smallfont"><p>Tried and still got the problem...</p>

<p>Is there a way to increase trace level and try to find out what's going wrong ?</p>

<p>Thanks.<br/>
JS</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 18, 2013 18:22
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529427"></a>
                                    <font class="smallfont"><p>Can you send me your openremote.zip (download from designer)?<br/>
marcus (at) openremote (dot) org</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 18, 2013 20:35
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529455"></a>
                                    <font class="smallfont"><p>I received the file and tested it.<br/>
The problem in this case is the TCP command which has a bug in combination with custom sensor and state mapping.<br/>
I created a JIRA issue for this but can't say when this will be fixed.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 19, 2013 22:37
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529456"></a>
                                    <font class="smallfont"><p>Hello Marcus,</p>

<p>I'll try through HTTP while waiting for a fix.</p>

<p>Thanks a lot for your help<br/>
Jean-Sébastien.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 19, 2013 23:17
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529476"></a>
                                    <font class="smallfont"><p>Hello again,</p>

<p>Works great with HTTP indeed !<br/>
But it'a a bit more overhead on both the sensor (which generate an xml response) and on OpenRemote Controller (which has to parse XML output).</p>

<p>But I can live with that <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Thanks again<br/>
JS</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 20, 2013 10:41
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21529534"></a>
                                    <font class="smallfont"><p>Hello Jean Sébastien,</p>

<p>Same issue with my IPX and openremote, the status by tcp don't work, I also think there might be a problem with the "=" in the custom state. <br/>
Same resolution there :<br/>
<a href="http://www.gce-electronics.com/forum/viewtopic.php?f=18&amp;t=792">Forum GCE</a><br/>
Thanks Markus to have a look to this, you will help many IPX800 users if you find how to manage TCP status !</p>

<p>Regards,</p>

<p>&#8211;<br/>
Veance</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by veance at Jan 21, 2013 08:12
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21856657"></a>
                                    <font class="smallfont"><p>Ok, I created a fix and changed the TCPCommand to implement the newer EventListener interface.<br/>
This should fix the issue with the states when using a CustomSensor.</p>

<p>Since this also requires extra attributes defined in the controller.xml file, you can only test this if you change your controller.xml after a sync and restart or your controller.<br/>
The extra attribute needed is "pollingInterval" and it takes a value in milliseconds or something like "1s" (seconds) or "1m" (minutes).<br/>
You can also use the "regex" attribute now to filter the received TCP answer.</p>

<p>To test this, just copy the attached 2 files in your "webapps/controller/WEB-INF/classes/org/openremote/controller/protocol/socket" folder.</p>

<p><a href="attachments/21529339/22052872.class">TCPSocketCommandBuilder.class</a><br/>
<a href="attachments/21529339/22052871.class">TCPSocketCommand.class</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Jan 27, 2013 22:54
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21856679"></a>
                                    <font class="smallfont">
<p>Thanks Marcus for the job, I will test it tomorrow and let you know.</p>

<p>Regards,</p>

<p>&#8211;<br/>
Veance</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by veance at Jan 28, 2013 08:12
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21856713"></a>
                                    <font class="smallfont"><p>Hello Marcus,</p>

<p>It is now working :</p>

<p>2013-01-28 22:34:15,048 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=1, received on<br/>
2013-01-28 22:34:16,092 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=1, received on<br/>
2013-01-28 22:34:17,137 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=0, received off<br/>
2013-01-28 22:34:18,195 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=0, received off<br/>
2013-01-28 22:34:19,423 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=0, received off<br/>
2013-01-28 22:34:20,492 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=1, received on<br/>
2013-01-28 22:34:21,523 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=1, received on<br/>
2013-01-28 22:34:22,580 TRACE <span class="error">&#91;Polling thread for sensor: Out1\-State\-TCP&#93;</span>: Processed GetOut1=1, received on</p>

<p>I also tried to create a switch based on the sensor and it is also working !</p>

<p>Thanks a lot for looking into this.<br/>
Now I just can't wait for the Composer to be updated so we can enter the options and especially pollingInterval <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0"/></p>

<p>Thanks again<br/>
Jean-Sébastien</p>

<p>@Veance : Thanks for pointing to the GCE post. I must admit I didn't check there...</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by jsroques at Jan 28, 2013 21:41
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21859334"></a>
                                    <font class="smallfont"><p>Marcus,<br/>
I am having the same issue now. After defining custom sensors for denon using TCP/IP commands I am not getting the ON/OFF on the label that I created, instead I get State-1 for PWON. I created the customer sensor with Name =ON and Value=PWON.<br/>
I am using Openremote 2.0.2 and tried replacing the two files shown above. When I do that it says something like implementation error with no polling interval.</p>

<p>Any chance I can fix it?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by iloveautomation at Mar 28, 2013 18:47
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21859340"></a>
                                    <font class="smallfont"><p>You need to add pollingInterval attribute to the command in your generated controller.xml</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by mredeker at Mar 28, 2013 20:52
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-21859414"></a>
                                    <font class="smallfont"><p>Thanks Marcus. That worked!!</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by iloveautomation at Mar 31, 2013 21:12
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:44</font></td>
		    </tr>
	    </table>
    </body>
</html>