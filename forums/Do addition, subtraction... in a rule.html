<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Forums : Do addition, subtraction... in a rule</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Forums : Do addition, subtraction... in a rule
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Dec 13, 2013 by <font color="#0050B2">petitrabot</font>.
				    </div>

				    <p>Hello, sorry again for my english...<br/>
My config is IPX800-V3, sensor temperature SHT-X3 and OpenRemote.</p>

<p>I want to display the temperature on a label. I read the value in "status.xml".<br/>
The problem is that this value is an analog value and not a temperature value.<br/>
Is it possible to do a rule which convert this analog value in temperature value?<br/>
Exemple: the analog value is 686 and the real temperature is 18°C<br/>
Convert: (686-506)/10 = 18</p>

<p>And after, I want to write this temerature value in a label.<br/>
Can you help me to do the rule, please.<br/>
Thank you very much.</p>

<p>Guillaume</p>

				    					    <br/>
                        <div class="tabletitle">
                            <a name="attachments">Attachments:</a>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036308.png">1.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036309.png">2.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036310.png">3.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036311.png">4.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036315.png">5.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036316.png">6.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036317.png">7.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036318.png">IMG_0778[1].PNG</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036319.png">IMG_0778.PNG</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/22881142/23036320.png">2013-12-13_164132.png</a> (image/png)
                                <br/>
                                                    </div>
				    
                                            <div class="tabletitle">
                            <a name="comments">Comments:</a>
                        </div>

                        <table border="0" width="100%">
                                                        <tr>
                                <td >
                                    <a name="comment-22881144"></a>
                                    <font class="smallfont"><p>Have a look at Michal Rutka's <a href="http://mqlservice.net/openremote/2013/05/22/temperature-sensors-calibration/">calibration example</a></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Dec 13, 2013 07:34
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881147"></a>
                                    <font class="smallfont"><p>Thank you PIETER ZANSTRA for your answer. I try this and I'll let you know.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 08:23
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881150"></a>
                                    <font class="smallfont"><p>I have try your solution, but I'm novice in OpenRemote, and I can't get it to work...<br/>
I have try this:</p>

<p>I have a command "Température"<br/>
<img src="attachments/22881142/23036308.png" align="absmiddle" border="0"/><br/>
which read the sensor value in xml file.</p>

<p>I have a command "VTEMP"<br/>
<img src="attachments/22881142/23036309.png" align="absmiddle" border="0"/></p>

<p>I have a sensor "Sonde température"<br/>
<img src="attachments/22881142/23036310.png" align="absmiddle" border="0"/><br/>
joined to the command "VTEMP"</p>

<p>I have the rule "Correct Température"</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
rule <span class="code-quote">"Correct Température"</span>
when
  CustomState(source==<span class="code-quote">"Température"</span>, $v: value)
then
  <span class="code-object">double</span> correctedValue = <span class="code-object">Double</span>.parseDouble($v.toString()) - 2.5;
  <span class="code-object">double</span> fahrenheit = (correctedValue*9) / 5 + 32;
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103 / %.1f \u2109"</span>, correctedValue, fahrenheit));
end
</pre>
</div></div>

<p>And to finish, I have a label<br/>
<img src="attachments/22881142/23036311.png" align="absmiddle" border="0"/><br/>
joined to the sensor "Sonde température"</p>

<p>I hope you understand what I have do.<br/>
Thank for you help</p>




</font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 09:00
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881151"></a>
                                    <font class="smallfont"><p>You need 2 changes:</p>

<p>1. "Sonde température" sensor should be linked to the command "Température"<br/>
2. In the rule when statement you should use the sensor:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
  CustomState(source==<span class="code-quote">"Sonde température"</span>, $v: value)
</pre>
</div></div>
<p>Furthermore, if you want to show VTEMP in a label then you need a new custom sensor using command "VTEMP", and use this sensor in UI label.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 09:38
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881153"></a>
                                    <font class="smallfont"><p>Quick response:<br/>
The polling interval in the temperature command is missing the time units I think should be 100s if you want seconds.<br/>
PS: For better readability you could enclose your rule code within {code}..{code} tags <a href="http://www.openremote.org/display/website/Wiki+Markup+Quick+Start">(see markup instructions)</a>. Do not place a / inside the end tag.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Dec 13, 2013 09:41
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881167"></a>
                                    <font class="smallfont"><p>Normaly, if I don't write the unit, it's automatic in ms.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 12:01
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881168"></a>
                                    <font class="smallfont"><p>1. I have linked "Sonde température" to the command "Température"<br/>
<img src="attachments/22881142/23036315.png" align="absmiddle" border="0"/></p>

<p>2. I have modify the rule:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
rule <span class="code-quote">"Correct Température"</span>
when
  CustomState(source==<span class="code-quote">"Sonde température"</span>, $v: value)
then
  <span class="code-object">double</span> correctedValue = <span class="code-object">Double</span>.parseDouble($v.toString()) - 2.5;
  <span class="code-object">double</span> fahrenheit = (correctedValue*9) / 5 + 32;
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103 / %.1f \u2109"</span>, correctedValue, fahrenheit));
end </pre>
</div></div>

<p>3. I have create a new sensor "VTEMP Sensor" and linked whit VTEMP<br/>
<img src="attachments/22881142/23036316.png" align="absmiddle" border="0"/></p>

<p>4. and to finish, I have use this sensor in UI label<br/>
<img src="attachments/22881142/23036317.png" align="absmiddle" border="0"/></p>

<p>I have save and upload, but the result in the label is "Label Text"...</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 12:07
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881169"></a>
                                    <font class="smallfont"><p>You're right! </p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Dec 13, 2013 12:44
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881172"></a>
                                    <font class="smallfont"><p>It seems OK on the first look. Things to check:</p>

<p>1. Make a label and link it to "Sonde température" to be sure that reading of the xml file is OK.<br/>
2. Try to rename your sensors to not contain characters beyond standard ASCII, i.e. don't use é. Depending on you system configuration this can cause some problems.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 13:18
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881173"></a>
                                    <font class="smallfont"><p>1. I have make a new label, and linked with "Sonde température" and it's OK<br/>
The first il the label with "VTEMP" and the second with "Sonde température"</p>

<p><img src="attachments/22881142/23036319.png" align="absmiddle" border="0"/></p>

<p>2. I have renamemy sensor, but the problem it's the same.</p>

<p>Is it possible to view the status of the variables in the rule?</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 13:25
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881180"></a>
                                    <font class="smallfont"><p>Are you sure it's this for "VTEMP"?</p>

<p><img src="attachments/22881142/23036309.png" align="absmiddle" border="0"/></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 13:37
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881181"></a>
                                    <font class="smallfont"><p>You need to make sure that your rule file is parsed without errors. Please take a look at OR/logs/boot.log file and check if there are no errors when starting drools.</p>

<blockquote>
<p>Is it possible to view the status of the variables in the rule?</p></blockquote>
<p>Not exactly, but you can generate logs for drools execution which would make debugging easier. Check this thread for it <a href="http://www.openremote.org/display/forums/Drools+rule+activation+feedback?focusedCommentId=22879252#comment-22879252">http://www.openremote.org/display/forums/Drools+rule+activation+feedback?focusedCommentId=22879252#comment-22879252</a></p>

<p>With this build you can also easily add custom entries to the log like this:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"<span class="code-object">System</span> start"</span>
when eval(<span class="code-keyword">true</span>)
then
  log(<span class="code-quote">"Drools start OK"</span>);
end
</pre>
</div></div>

<p>Alternatively you can simply write each variable to the virtual command linked to sensor linked to label. So to see drools start OK status in your UI:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
rule <span class="code-quote">"<span class="code-object">System</span> start"</span>
when eval(<span class="code-keyword">true</span>)
then
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-quote">"Drools start OK"</span>);
end
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 13:57
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881182"></a>
                                    <font class="smallfont"><blockquote>
<p>Are you sure it's this for "VTEMP"?</p></blockquote>
<p>Yes.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 13:58
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881183"></a>
                                    <font class="smallfont"><p>Thank you for your help. I wait your answer, but it's finish for me for today, I can start. I will continue last week. Good weekend for you.</p>

<p>This is the result in the log file:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
INFO 2013-12-13 15:24:51,453 : 

--------------------------------------------------------------------

  UNDEPLOYING CURRENT CONTROLLER RUNTIME...

--------------------------------------------------------------------

INFO 2013-12-13 15:24:51,453 : Stopped event processor : Drools Rule Engine
INFO 2013-12-13 15:24:51,480 : Stopped event processor : RRD4J Data Logger
INFO 2013-12-13 15:24:51,480 : Stopped event processor : EmonCMS Data Logger
INFO 2013-12-13 15:24:51,480 : Shutdown complete.
INFO 2013-12-13 15:24:51,482 : 

--------------------------------------------------------------------

  DEPLOYING NEW CONTROLLER RUNTIME...

--------------------------------------------------------------------

ERROR 2013-12-13 15:24:51,578 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2013-12-13 15:24:51,578 : Rule Compilation error command cannot be resolved
ERROR 2013-12-13 15:24:51,578 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
	at org.openremote.controller.service.Deployer.startup(Deployer.java:858)
	at org.openremote.controller.service.Deployer.softRestart(Deployer.java:440)
	at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1324)
	at java.lang.<span class="code-object">Thread</span>.run(<span class="code-object">Thread</span>.java:662)
INFO 2013-12-13 15:24:51,581 : Initialized event processor : Drools Rule Engine
INFO 2013-12-13 15:24:51,589 : Initialized event processor : RRD4J Data Logger
INFO 2013-12-13 15:24:51,589 : Initialized event processor : EmonCMS Data Logger
INFO 2013-12-13 15:24:51,592 : Registered sensor : Sensor (Name = 'Délestage total SENSOR', ID = '100', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-13 15:24:51,592 : Registered sensor : Sensor (Name = 'VTEMP Sensor', ID = '101', State Mappings: {})
INFO 2013-12-13 15:24:51,592 : Registered sensor : Sensor (Name = 'Délestage partiel SENSOR', ID = '98', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-13 15:24:51,593 : Registered sensor : Sensor (Name = 'Sonde temperature', ID = '99', State Mappings: {})
INFO 2013-12-13 15:24:51,596 : Startup complete.
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 14:25
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881185"></a>
                                    <font class="smallfont"><p>So you have a compilation error and your rule file is not executing. If you are unable to spot and fix it then send your WHOLE rule file. I can take a look if it is not too large.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 14:32
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881188"></a>
                                    <font class="smallfont"><p>The In-memory Virtual Cammands can be either <em>on, off</em> or <em>status</em>. I don't know if it is case sensitive. In OpenRemote I always use the lower case variants of these "words"</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by pz1 at Dec 13, 2013 14:59
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881191"></a>
                                    <font class="smallfont"><p>Actualy, in rules editor, I have just what you gave me.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"> <span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"<span class="code-object">System</span> start"</span>
when eval(<span class="code-keyword">true</span>)
then
  command.execute(<span class="code-quote">"VTEMP"</span>, <span class="code-quote">"Drools start OK"</span>);
end
</pre>
</div></div>

<p><img src="attachments/22881142/23036320.png" align="absmiddle" border="0"/></p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 13, 2013 15:42
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881193"></a>
                                    <font class="smallfont"><p>Add these to begin of the file:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol;
global org.openremote.controller.statuscache.CommandFacade execute;
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 13, 2013 18:15
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881443"></a>
                                    <font class="smallfont"><p>Hello, I'm back, and I have make a new test.<br/>
In my rule:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">package</span> org.openremote.controller.protocol;
global org.openremote.controller.statuscache.CommandFacade execute;

<span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"<span class="code-object">System</span> start"</span>
when eval(<span class="code-keyword">true</span>)
then
  command.execute(<span class="code-quote">"VTEMP"</span>, <span class="code-quote">"Drools start OK"</span>);
end</pre>
</div></div>

<p>And in the log file:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">--------------------------------------------------------------------

  DEPLOYING NEW CONTROLLER RUNTIME...

--------------------------------------------------------------------

ERROR 2013-12-19 17:34:29,079 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2013-12-19 17:34:29,079 : Rule Compilation error command cannot be resolved
ERROR 2013-12-19 17:34:29,080 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
	at org.openremote.controller.service.Deployer.startup(Deployer.java:858)
	at org.openremote.controller.service.Deployer.softRestart(Deployer.java:440)
	at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1324)
	at java.lang.<span class="code-object">Thread</span>.run(<span class="code-object">Thread</span>.java:662)
INFO 2013-12-19 17:34:29,085 : Initialized event processor : Drools Rule Engine
INFO 2013-12-19 17:34:29,099 : Initialized event processor : RRD4J Data Logger
INFO 2013-12-19 17:34:29,099 : Initialized event processor : EmonCMS Data Logger
INFO 2013-12-19 17:34:29,106 : Registered sensor : Sensor (Name = 'Délestage total SENSOR', ID = '100', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-19 17:34:29,106 : Registered sensor : Sensor (Name = 'VTEMP Sensor', ID = '101', State Mappings: {})
INFO 2013-12-19 17:34:29,110 : Registered sensor : Sensor (Name = 'Délestage partiel SENSOR', ID = '98', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-19 17:34:29,111 : Registered sensor : Sensor (Name = 'Sonde temperature', ID = '99', State Mappings: {})
INFO 2013-12-19 17:34:29,115 : Startup complete. </pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 19, 2013 16:40
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881444"></a>
                                    <font class="smallfont"><p>Change<br/>
command.execute("VTEMP", "Drools start OK");<br/>
to<br/>
execute.command("VTEMP", "Drools start OK");</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 19, 2013 16:47
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881445"></a>
                                    <font class="smallfont"><p>I have modify "command.execute" by "execute.command" and this is the result:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"> --------------------------------------------------------------------

  DEPLOYING NEW CONTROLLER RUNTIME...

--------------------------------------------------------------------

INFO 2013-12-19 18:23:54,850 : Initialized event processor : Drools Rule Engine
INFO 2013-12-19 18:23:54,857 : Initialized event processor : RRD4J Data Logger
INFO 2013-12-19 18:23:54,858 : Initialized event processor : EmonCMS Data Logger
INFO 2013-12-19 18:23:54,860 : Registered sensor : Sensor (Name = 'Délestage total SENSOR', ID = '100', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-19 18:23:54,861 : Registered sensor : Sensor (Name = 'VTEMP Sensor', ID = '101', State Mappings: {})
INFO 2013-12-19 18:23:54,861 : Registered sensor : Sensor (Name = 'Délestage partiel SENSOR', ID = '98', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-19 18:23:54,861 : Registered sensor : Sensor (Name = 'Sonde temperature', ID = '99', State Mappings: {})
INFO 2013-12-19 18:23:54,864 : Startup complete.
</pre>
</div></div>

<p>And I have "Drools start OK" on my iphone screen.<br/>
Now, I can adjust to view the temperature.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 19, 2013 17:26
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881473"></a>
                                    <font class="smallfont"><p>Now, I have modify my rule to view room temperature.<br/>
This is my rule:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol;
global org.openremote.controller.statuscache.CommandFacade execute;

<span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"<span class="code-object">System</span> start"</span>
when eval(<span class="code-keyword">true</span>)
then
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-quote">"Drools start OK"</span>);
end

rule <span class="code-quote">"Correct Temperature"</span>
when
  CustomState(source==<span class="code-quote">"Sonde temperature"</span>, $v: value)
then
  <span class="code-object">double</span> correctedValue = <span class="code-object">Double</span>.parseDouble($v.toString()) - 2.5;
  <span class="code-object">double</span> fahrenheit = (correctedValue*9) / 5 + 32;
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103 / %.1f \u2109"</span>, correctedValue, fahrenheit));
end
</pre>
</div></div>

<p>And this is the report:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
ERROR 2013-12-20 13:14:45,632 : Rule definition 'modeler_rules.drl' could not be deployed. See errors below.
ERROR 2013-12-20 13:14:45,632 : Unable to resolve ObjectType 'CustomState'
ERROR 2013-12-20 13:14:45,632 : Rule Compilation error $v cannot be resolved
ERROR 2013-12-20 13:14:45,633 : There was an error parsing the rule definition 'modeler_rules.drl' : Could not parse knowledge.
java.lang.IllegalArgumentException: Could not parse knowledge.
	at org.drools.builder.impl.KnowledgeBuilderImpl.newKnowledgeBase(KnowledgeBuilderImpl.java:58)
	at org.openremote.controller.statuscache.rules.RuleEngine.getValidKnowledgePackages(RuleEngine.java:532)
	at org.openremote.controller.statuscache.rules.RuleEngine.start(RuleEngine.java:253)
	at org.openremote.controller.statuscache.EventProcessorChain.start(EventProcessorChain.java:112)
	at org.openremote.controller.statuscache.StatusCache.start(StatusCache.java:120)
	at org.openremote.controller.deployer.Version20ModelBuilder.buildSensorModel(Version20ModelBuilder.java:659)
	at org.openremote.controller.deployer.Version20ModelBuilder.build(Version20ModelBuilder.java:557)
	at org.openremote.controller.deployer.AbstractModelBuilder.buildModel(AbstractModelBuilder.java:154)
	at org.openremote.controller.service.Deployer.startup(Deployer.java:858)
	at org.openremote.controller.service.Deployer.softRestart(Deployer.java:440)
	at org.openremote.controller.service.Deployer$ControllerDefinitionWatch.run(Deployer.java:1324)
	at java.lang.<span class="code-object">Thread</span>.run(<span class="code-object">Thread</span>.java:662)
INFO 2013-12-20 13:14:45,636 : Initialized event processor : Drools Rule Engine
INFO 2013-12-20 13:14:45,644 : Initialized event processor : RRD4J Data Logger
INFO 2013-12-20 13:14:45,644 : Initialized event processor : EmonCMS Data Logger
INFO 2013-12-20 13:14:45,646 : Registered sensor : Sensor (Name = 'Délestage total SENSOR', ID = '100', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-20 13:14:45,647 : Registered sensor : Sensor (Name = 'VTEMP Sensor', ID = '101', State Mappings: {})
INFO 2013-12-20 13:14:45,647 : Registered sensor : Sensor (Name = 'Délestage partiel SENSOR', ID = '98', State Mappings: {1=ON, 0=OFF})
INFO 2013-12-20 13:14:45,649 : Registered sensor : Sensor (Name = 'Sonde temperature', ID = '99', State Mappings: {})
INFO 2013-12-20 13:14:45,650 : Startup complete.
</pre>
</div></div>

<p>I think, the problem is "CustomState", but I start programming, and I do not see the problem.<br/>
A new question, what is the language for OpenRemote?? It is JAVA or JavaScript or an other??</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 20, 2013 12:17
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881480"></a>
                                    <font class="smallfont"><p>add this to your imports:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">import</span> org.openremote.controller.model.event.*
</pre>
</div></div>

<p>The language is Java 1.6.</p></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by aktur at Dec 20, 2013 13:14
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881482"></a>
                                    <font class="smallfont"><p>Perfect Michal Rutka...<br/>
You are the boss.<br/>
Thank you very much for your help.<br/>
I post the code for another person like me.</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol;
global org.openremote.controller.statuscache.CommandFacade execute;

<span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-keyword">import</span> org.openremote.controller.model.event.*
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"Correct Temperature"</span>
when
  CustomState(source==<span class="code-quote">"Sonde temperature"</span>, $v: value)
then
  <span class="code-object">double</span> correctedValue = (<span class="code-object">Double</span>.parseDouble($v.toString()) - 506)/10;
  <span class="code-object">double</span> fahrenheit = (correctedValue*9) / 5 + 32;
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103 / %.1f \u2109"</span>, correctedValue, fahrenheit));
end
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 20, 2013 13:30
                                    </div>
                                </td>
                            </tr>
                                                        <tr>
                                <td  style="border-top: 1px dashed #666666">
                                    <a name="comment-22881496"></a>
                                    <font class="smallfont"><p>A last question (I hope),<br/>
when I write \u2103 the result is "°C", I sought to convert "%" and the result is \u0025.<br/>
I wrote two new rules or the result are in "%"<br/>
The problem is, if I write \u2103, I have my value and "°C", but if I write \u0025, I have nothing (just label text)</p>

<p>My new rules:</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java">
<span class="code-keyword">package</span> org.openremote.controller.protocol;
global org.openremote.controller.statuscache.CommandFacade execute;

<span class="code-comment">// For logger
</span><span class="code-keyword">import</span> org.openremote.controller.utils.Logger;
<span class="code-keyword">import</span> org.openremote.controller.Constants;
<span class="code-keyword">import</span> org.openremote.controller.model.event.*
<span class="code-comment">// For logger
</span>
function void log(<span class="code-object">String</span> msg)
{
  Logger.getLogger(Constants.RUNTIME_EVENTPROCESSOR_LOG_CATEGORY + <span class="code-quote">".drools"</span>).debug(msg);
}

rule <span class="code-quote">"Correct Temperature"</span>
when
  CustomState(source==<span class="code-quote">"Sonde temperature"</span>, $v: value)
then
  <span class="code-object">double</span> correctedValue = (<span class="code-object">Double</span>.parseDouble($v.toString())-506)/10;
  execute.command(<span class="code-quote">"VTEMP"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103"</span>, correctedValue));
end


rule <span class="code-quote">"Correct Luminosite"</span>
when
  CustomState(source==<span class="code-quote">"Sonde luminosite"</span>, $v: value)
then
  <span class="code-object">double</span> correctedLumValue = <span class="code-object">Double</span>.parseDouble($v.toString())/10;
  execute.command(<span class="code-quote">"VLUM"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103"</span>, correctedLumValue));
end

rule <span class="code-quote">"Correct hygrometrie"</span>
when
  CustomState(source==<span class="code-quote">"Sonde hygrometrie"</span>, $v: value)
then
  <span class="code-object">double</span> correctedHyValue = <span class="code-object">Double</span>.parseDouble($v.toString())/10;
  execute.command(<span class="code-quote">"VHYG"</span>, <span class="code-object">String</span>.format(<span class="code-quote">"%.1f \u2103"</span>, correctedHyValue));
end
</pre>
</div></div></font>
                                    <div align="left" class="smallfont" style="color: #666666; width: 98%; margin-bottom: 10px;">
                                        <img src="images/icons/comment_16.gif" height="16" width="16" border="0" align="absmiddle"/>
                                        Posted by petitrabot at Dec 20, 2013 15:50
                                    </div>
                                </td>
                            </tr>
                                                    </table>
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://www.openremote.org/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jun 05, 2016 09:35</font></td>
		    </tr>
	    </table>
    </body>
</html>